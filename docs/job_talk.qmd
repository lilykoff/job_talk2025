---
title: "Methods and Applications for High-Frequency Biosignals Data"
title-slide-attributes:
    data-background-image: figs/qr_code.png
    data-background-size: 20%
    data-background-position: 95% 95%
subtitle: ""
author: "Lily Koffman"
institute: "Department of Biostatistics, Johns Hopkins School of Public Health" 
format:
  revealjs:
    theme: custom.scss
    slide-number: false
    toc: false
    progress: true
    hash: true
    overview: true
    code-overflow: wrap
    code-line-numbers: false
    center: false
    width: 1400
    height: 850
    html-math-method: mathjax
    embed-resources: true
code: 
  echo: false
  cache: true 
editor_options: 
  chunk_output_type: console
bibliography: references.bib
---

```{r load packages}
#| include: false 

library(patchwork)
library(tidyverse)
library(ggridges)
library(paletteer)
library(viridis)
library(geomtextpath)
library(showtext)
library(scales)
library(ggplot2)
library(ggrepel)
library(broom)
library(survival)
library(ggimage)
library(cowplot)
options(digits.secs = 3)

```

```{r misc functions}
#| include: false 
range_left = function(x, left, right){
  ifelse(x > left & x <= right, TRUE, FALSE)
}

get_density = function(x, y, ...) {
  dens <- MASS::kde2d(x, y, ...)
  ix <- findInterval(x, dens$x)
  iy <- findInterval(y, dens$y)
  ii <- cbind(ix, iy)
  return(dens$z[ii])
}

```

```{r ggplot theme}
#| include: false  

okabe_ito <- c(
  "#000000", "#E69F00", "#56B4E9", "#009E73",
  "#F0E442", "#0072B2", "#D55E00", "#CC79A7"
)

showtext_auto()
font_add_google("Source Sans Pro", "Source Sans Pro")
theme_set(
  theme_minimal(base_family = "Source Sans Pro") +
    theme(
      plot.background = element_rect(fill = "#f6f5f3", color = NA),
      panel.background = element_rect(fill = "#f6f5f3", color = NA),
      panel.grid.major = element_line(color = "#e1dfdb"),
      panel.grid.minor = element_blank(),
      axis.text = element_text(color = "#1a1a1a", size = 12),
      axis.title = element_text(color = "#1a1a1a", size = 14),
      plot.title = element_text(face = "bold", size = 18, color = "#000000"),
      plot.subtitle = element_text(size = 14, color = "#444444"),
      strip.background = element_rect(fill = "darkgrey", color = NA),
      strip.text = element_text(color = "white", size = 12)
    )
)

scale_color_okabe <- function(...) scale_color_manual(values = okabe_ito, ...)
scale_fill_okabe  <- function(...) scale_fill_manual(values = okabe_ito, ...)

```


```{r data read in and processing}
#| cache: true 
#| include: false

# --- accel data ----- # 
walking = read_rds(here::here("docs", "data", "walking.rds"))
driving = read_rds(here::here("docs", "data", "driving.rds"))
cooking = read_rds(here::here("docs", "data", "cooking.rds"))

# --- paper 1 results --- # 
pred_df = read_rds(here::here("docs", "data", "paper1_preds.rds"))

# --- step comparison results --- # 
step_acc = read_rds(here::here("docs", "data", "accuracy_stats_bysubject_redone.rds"))
step_res = read_rds(here::here("docs", "data", "total_steps_bysubject_redone.rds"))

# --- nhanes step estimates --- # 
steps = read_rds(here::here("docs", "data", "covariates_accel_mortality_df.rds")) %>% 
  filter(valid_accel) 

# --- nhanes mortality estimates --- # 
dose_resp = read_rds(here::here("docs", "data", "dose_response_dat.rds"))
rug_dat = read_rds(here::here("docs", "data", "rug_dat.rds")) %>% 
  filter(stepvar == "Stepcount RF") %>% 
  mutate(stepvar = "total_scrfsteps")

# --- minute level steps df ---- # 
steps_summ = read_rds(here::here("docs", "data", "step_means.rds")) 

# --- survey sim results --- # 
res_g = read_rds(here::here("docs", "data", "survey_sim_res.rds"))

# ---- survey application --- # 
plt_df_boot = read_rds(here::here("docs", "data", "step_application.rds"))

# --- nh fprint ---- # 
dens_df = read_rds(here::here("docs", "data", "dens_temp_df.rds")) 
sample_dat2 = read_rds(here::here("docs", "data", "fingerprint_data_sample_temporal.rds"))

# --- hemo data ---- # 
hemo_data0 = read_csv(here::here("docs", "data", "1156602.csv.gz")) %>% filter(cat_anes == "intra")

hemo_data = read_csv(here::here("docs", "data", "1004841.csv.gz")) %>% 
  filter(cat_anes == "intra")

# ---- hemo results --- # 
mean_preds = read_rds(here::here("docs", "data", "mean_preds_xgb.rds"))

pred_res = read_rds(here::here("docs", "data", "pred_res_df_xgb.rds"))


correct = pred_res %>% 
  filter(rank1 == 1)

# ---- accel data ---- # 

data = read_csv(here::here("docs", "data", "df_all_IU.csv"))

iu_dat =
  data %>%
  rename(vm = signal_lw)

df =
  iu_dat %>%
  filter(between(time, 200, 201), ID2 == 4) %>%
  mutate(lag_vm = lag(vm, n = 15)) %>%
  mutate(time = time - min(time))

df30 =
  iu_dat %>%
  filter(between(time, 200, 201), ID2 == 4) %>%
  mutate(lag_vm = lag(vm, n = 30)) %>%
  mutate(time = time - min(time))

df2 =
  iu_dat %>%
  filter(between(time, 201, 202), ID2 == 4) %>%
  mutate(lag_vm = lag(vm, n = 15)) %>%
  mutate(time = time - min(time))

df2_30 =
  iu_dat %>%
  filter(between(time, 201, 202), ID2 == 4) %>%
  mutate(lag_vm = lag(vm, n = 30)) %>%
  mutate(time = time - min(time))

df3 =
  iu_dat %>%
  filter(between(time, 101, 102), ID2 == 2) %>%
  mutate(lag_vm = lag(vm, n = 15)) %>%
  mutate(time = time - min(time))

df3_30 =
  iu_dat %>%
  filter(between(time, 101, 102), ID2 == 2) %>%
  mutate(lag_vm = lag(vm, n = 30)) %>%
  mutate(time = time - min(time))

df3_302 =
  iu_dat %>%
  filter(between(time, 102, 103), ID2 == 2) %>%
  mutate(lag_vm = lag(vm, n = 30)) %>%
  mutate(time = time - min(time))

df3_152 =
  iu_dat %>%
  filter(between(time, 102, 103), ID2 == 2) %>%
  mutate(lag_vm = lag(vm, n = 15)) %>%
  mutate(time = time - min(time))

df4 =
  iu_dat %>%
  filter(between(time, 201, 202), ID2 == 6) %>%
  mutate(lag_vm = lag(vm, n = 15)) %>%
  mutate(time = time - min(time))


# ------- densities -------- # 
dens_df_s2_l15 =
  iu_dat %>%
  filter(ID2 == 2) %>% 
  mutate(time = (row_number() / 100) - 0.01) %>%
  mutate(s = floor(time)) %>%
  filter(s <= 240) %>%
  group_by(s) %>%
  mutate(lag_vm = lag(vm, n = 15)) %>%
  ungroup()  %>%
  drop_na()

dens_df_s2_l15$density = get_density(dens_df_s2_l15$vm, dens_df_s2_l15$lag_vm, n = 100)

dens_df_s2_l30 =
  iu_dat %>%
  filter(ID2 == 2) %>% 
  mutate(time = (row_number() / 100) - 0.01) %>%
  mutate(s = floor(time)) %>%
  filter(s <= 240) %>%
  group_by(s) %>%
  mutate(lag_vm = lag(vm, n = 30)) %>%
  ungroup()  %>%
  drop_na()

dens_df_s2_l30$density = get_density(dens_df_s2_l30$vm, dens_df_s2_l30$lag_vm, n = 100)

dens_df_s4_l15 =
  iu_dat %>%
  filter(ID2 == 4) %>% 
  mutate(time = (row_number() / 100) - 0.01) %>%
  mutate(s = floor(time)) %>%
  filter(s <= 240) %>%
  group_by(s) %>%
  mutate(lag_vm = lag(vm, n = 15)) %>%
  ungroup()  %>%
  drop_na()

dens_df_s4_l15$density = get_density(dens_df_s4_l15$vm, dens_df_s4_l15$lag_vm, n = 100)

dens_df_s4_l30 =
  iu_dat %>%
  filter(ID2 == 4) %>% 
  mutate(time = (row_number() / 100) - 0.01) %>%
  mutate(s = floor(time)) %>%
  filter(s <= 240) %>%
  group_by(s) %>%
  mutate(lag_vm = lag(vm, n = 30)) %>%
  ungroup()  %>%
  drop_na()

dens_df_s4_l30$density = get_density(dens_df_s4_l30$vm, dens_df_s4_l30$lag_vm, n = 100)

dens_df_s6_l15 =
  iu_dat %>%
  filter(ID2 == 6) %>% 
  mutate(time = (row_number() / 100) - 0.01) %>%
  mutate(s = floor(time)) %>%
  filter(s <= 240) %>%
  group_by(s) %>%
  mutate(lag_vm = lag(vm, n = 15)) %>%
  ungroup()  %>%
  drop_na()

dens_df_s6_l15$density = get_density(dens_df_s6_l15$vm, dens_df_s6_l15$lag_vm, n = 100)

dens_df_s6_l30 =
  iu_dat %>%
  filter(ID2 == 6) %>% 
  mutate(time = (row_number() / 100) - 0.01) %>%
  mutate(s = floor(time)) %>%
  filter(s <= 240) %>%
  group_by(s) %>%
  mutate(lag_vm = lag(vm, n = 30)) %>%
  ungroup()  %>%
  drop_na()

dens_df_s6_l30$density = get_density(dens_df_s6_l30$vm, dens_df_s6_l30$lag_vm, n = 100)
```


## Introduction: accelerometry data 

```{r accel plot}
#| cache: true
img_plot = ggplot() +
  ggimage::geom_image(aes(x = 0.5, y = 0.5, image = here::here("docs/figs/actigraph.png")), size = 1) +
  theme_void() + 
  theme(
      plot.background = element_rect(fill = "#f6f5f3", color = NA),
      panel.background = element_rect(fill = "#f6f5f3", color = NA)
    )


p1 = 
  driving %>% 
  ggplot(aes(x = t, y = vm))+
  geom_line(linewidth = 0.9, color = "#0072B2")+
  theme(panel.grid.minor = element_blank()) +
  labs(x = "Time (s)", y = "Acceleration (g)") + 
  scale_x_continuous(breaks=seq(0,10,1)) +
  scale_y_continuous(limits = c(0.5, 1.75)) + 
  annotate(geom = "label", x = 5, y = 1.5, label = "Driving (passenger)", size = 8, color = "#0072B2")

p2 = 
  cooking %>% 
  ggplot(aes(x = t, y = vm))+
  geom_line(linewidth = 0.9, color = "#009E73")+
  theme(panel.grid.minor = element_blank()) +
  labs(x = "Time (s)", y = "Acceleration (g)") + 
  scale_x_continuous(breaks=seq(0,10,1)) +
  scale_y_continuous(limits = c(0.5, 1.75)) +
  annotate(geom = "label", x = 5, y = 1.5, label = "Cooking", size = 8, color = "#009E73")


p3 = 
  walking %>% 
  ggplot(aes(x = t, y = vm))+
  geom_line(linewidth = 0.9, color = "#CC79A7")+
  theme(panel.grid.minor = element_blank()) +
  labs(x = "Time (s)", y = "Acceleration (g)") + 
  scale_x_continuous(breaks = seq(0,10,1)) + 
  scale_y_continuous(limits = c(0.5, 1.75)) +
  annotate(geom = "label", x = 5, y = 1.5, label = "Walking", size = 8, color = "#CC79A7")



img_plot + (p1 / p2 / p3 + plot_layout(guides = "collect", axes = "collect"))
```

## Introduction: **big** accelerometry data 

```{r accel plot nhanes}
#| cache: true
nh_img_plot = ggplot() +
  ggimage::geom_image(aes(x = 0.5, y = 0.5, image = here::here("docs/figs/nhanes.png")), size = 1) +
  theme_void() + 
  theme(
      plot.background = element_rect(fill = "#f6f5f3", color = NA),
      panel.background = element_rect(fill = "#f6f5f3", color = NA)
    )



p3_annotated = p3 + plot_annotation(
  caption = "80 observations per second\n× 60 seconds/minute\n× 1440 minutes/day\n× 7 days\n× 15,000 individuals\n=726 billion data points",
  theme = theme(
    plot.caption = element_text(
      hjust = 0.5,            # center the text
      vjust = 1,              # bring it up a bit
      size = 14,              # large and clear
      face = "bold",          # prominent
      family = "Source Sans Pro",
      color = "black",        # use a strong color
      lineheight = 1.1        # control spacing between lines
    ),
    plot.background = element_rect(fill = "#f2ede3", color = NA)
  )
  )

final_plot = nh_img_plot + 
  wrap_elements(p3_annotated) + 
  plot_layout(widths = c(1, 1), heights = c(1))

final_plot
```

## Outline {.question-bullets}

::: {.incremental}
<br>

- Can we identify someone from their walking pattern measured by a wrist-worn accelerometer? *(Digital fingerprinting)*
- Can we identify someone from their walking pattern measured by a wrist-worn accelerometer in big, free-living datasets? 
- Can we accurately find walking and count steps in free-living datasets? 
- Can we generalize conclusions from free-living accelerometry data to the US population? 
- Can we apply these methods in other, non-accelerometry datasets? 
:::

---

## Outline {.question-bullets}

<br>

- Can we identify someone from their walking pattern measured by a wrist-worn accelerometer? *(Digital fingerprinting)*
- <span style="color:gray;">Can we identify someone from their walking pattern measured by a wrist-worn accelerometer in big, free-living datasets?</span>
- <span style="color:gray;">Can we accurately find walking and count steps in free-living datasets? </span>
- <span style="color:gray;">Can we generalize conclusions from free-living accelerometry data to the US population?</span> 
- <span style="color:gray;">Can we apply these methods in other, non-accelerometry datasets? </span>



# Can we identify someone from their walking pattern measured by a wrist-worn accelerometer?

---

### Problem setup 


```{r accel problem setup}
#| cache: true
s1 = data %>% 
  filter(ID2 %in% c(2, 4, 6, 8, 9)) 

ymax = s1 %>% 
  filter(ID2 %in% c(2, 4, 6)) %>% 
  filter(time >= 20 & time < 30) %>% 
  pull(signal_lw) %>% 
  max()
  
ymin = s1 %>% 
  filter(ID2 %in% c(2, 4, 6)) %>% 
  filter(time >= 20 & time < 30) %>% 
  pull(signal_lw) %>% 
  min()  

label_df = 
  s1 %>% 
  filter(ID2 %in% c(2, 4, 6)) %>% 
  filter(time >= 20 & time < 30) %>% 
  mutate(ID2 = factor(ID2, labels = c("Person A", "Person B", "Person C"))) %>% 
  filter(time == 25) %>% 
  mutate(signal_lw = 2.5)

p1 =
  s1 %>% 
  filter(ID2 %in% c(2, 4, 6)) %>% 
  filter(time >= 20 & time < 30) %>% 
  mutate(ID2 = factor(ID2, labels = c("Person A", "Person B", "Person C"))) %>%
  ggplot(aes(x = time, y = signal_lw, color = ID2)) +
  geom_line(linewidth = 1) + 
  facet_wrap(.~ID2, ncol = 1) + 
  scale_color_manual(values = c("#E69F00", "#56B4E9", "#009E73")) +
  labs(x = "Time (s)", y = "Acceleration (g)") + 
  theme(legend.position = "none",
        panel.spacing = unit(0.1, "lines"), # tighten vertical spacing
        strip.text = element_blank(),
        strip.background = element_blank()) +
  scale_x_continuous(breaks=seq(20, 30, 2), labels= seq(0,10,2)) + 
  geom_label(data = label_df, aes(color = ID2, label = ID2), size = 8, show.legend = FALSE)


label_df2 = 
  s1 %>% 
  filter(ID2 %in% c(6, 8, 9)) %>% 
  filter(time >= 30 & time < 40) %>% 
  mutate(ID2 = factor(ID2, labels = c("Person ?", "Person ??", "Person ???"))) %>%
  filter(time == 35) %>% 
  mutate(signal_lw = 2.5)


p2 =
  s1 %>% 
  filter(ID2 %in% c(6, 8, 9)) %>% 
  filter(time >= 30 & time < 40) %>% 
  mutate(ID2 = factor(ID2, labels = c("Person ?", "Person ??", "Person ???"))) %>%
  ggplot(aes(x = time, y = signal_lw, color = ID2)) +
  geom_line(linewidth = 1) + 
  facet_wrap(.~ID2, ncol = 1) + 
  scale_color_manual(values = c("#D55E00","#CC79A7", "#000000")) +
  labs(x = "Time (s)", y = "Acceleration (g)") + 
  theme(legend.position = "none",
        panel.spacing = unit(0.1, "lines"), # tighten vertical spacing
        strip.text = element_blank(),
        strip.background = element_blank()) +
  scale_x_continuous(breaks=seq(30, 40, 2), labels= seq(0,10,2)) + 
  scale_y_continuous(limits=c(ymin, ymax)) +
  geom_label(data = label_df2, aes(color = ID2), label = "?", size = 8, show.legend = FALSE)


label_df3 = 
  s1 %>% 
  filter(ID2 %in% c(6, 8, 9)) %>% 
  filter(time >= 30 & time < 40) %>% 
  mutate(ID2 = factor(ID2, labels = c("Person C", "Person D", "Person E"))) %>%
  filter(time == 35) %>% 
  mutate(signal_lw = 2.5)

p3 =
  s1 %>% 
  filter(ID2 %in% c(6, 8, 9)) %>% 
  filter(time >= 30 & time < 40) %>% 
  mutate(ID2 = factor(ID2, labels = c("Person C", "Person D", "Person E"))) %>%
  ggplot(aes(x = time, y = signal_lw, color = ID2)) +
  geom_line(linewidth = 1) + 
  facet_wrap(.~ID2, ncol = 1) + 
  scale_color_manual(values = c("#009E73","#CC79A7", "#000000")) +
  labs(x = "Time (s)", y = "Acceleration (g)") + 
  theme(legend.position = "none",
        panel.spacing = unit(0.1, "lines"), # tighten vertical spacing
        strip.text = element_blank(),
        strip.background = element_blank()) +
  scale_x_continuous(breaks=seq(30, 40, 2), labels= seq(0,10,2)) + 
  scale_y_continuous(limits=c(ymin, ymax)) +
  geom_label(data = label_df3, aes(color = ID2, label = ID2), size = 8, show.legend = FALSE)

p_empty =
  s1 %>% 
  filter(ID2 %in% c(6, 8, 9)) %>% 
  filter(time >= 30 & time < 40) %>% 
  mutate(ID2 = factor(ID2, labels = c("Person C", "Person D", "Person E"))) %>%
  ggplot(aes(x = time, y = signal_lw, color = ID2)) +
  scale_x_continuous(breaks=seq(30, 40, 2), labels= seq(0,10,2)) + 
  theme_void() +
  theme(panel.background = element_rect(fill = "#f6f5f3", color = NA),
        plot.background = element_rect(fill = "#f6f5f3", color = NA))



# p1 + p_empty + plot_layout(widths = c(1, 1))
plot_grid(p1, p_empty, ncol = 2, align = "v", rel_widths = c(1,1))

```

---

### Problem setup 

```{r fingerprint question 2}
#| cache: true
# p1 + p2 + plot_layout(widths = c(1, 1))

plot_grid(p1, p2, ncol = 2, align = "v", rel_widths = c(1,1))

```

---

### Problem setup 

```{r fingerprint answer}
plot_grid(p1, p3, ncol = 2, align = "v", rel_widths = c(1,1))
```


---

### Big picture method: time series to scalar predictors

```{r def arrow}
arrow_plot = ggplot() +
  xlim(0,1) + ylim(0,1) +
  annotate(
    "segment",
    x = 0, xend = 1, y = 0.5, yend = 0.5,
    arrow = arrow(length = unit(0.2, "inches"), type = "closed"),
    color = "#D55E00", linewidth = 1.5
  ) +
  theme_void() +
  theme(plot.background = element_rect(fill = "#f6f5f3"))
```

```{r x matrix}
#| cache: true
n_rows = 15
n_cols = 10

# Create a dummy data frame for tiles
pred_matrix = expand_grid(
  row = 1:n_rows,
  col = 1:n_cols
) %>% 
  mutate(subj = 
           case_when(row %in% c(1:5) ~ 1,
                     row %in% c(6:10) ~ 2,
                     TRUE ~ 3)) %>% 
  rowwise() %>% 
  mutate(alpha = runif(1, 0, 1)) %>% 
  ungroup()


# Bracket offsets
vert_extend = 1.0   # how far the vertical line extends beyond top/bottom
hor_arm = 0.4       # horizontal arm length

# Left bracket `[`
left_bracket = tibble(
  # vertical line
  x = 0.5 - 0.3, xend = 0.5 - 0.3,
  y = 0.5 - vert_extend, yend = n_rows + 0.5 + vert_extend,
  # top horizontal
  x_top = 0.5 - 0.3, xend_top = 0.5 - 0.3 + hor_arm,
  y_top = n_rows + 0.5 + vert_extend, yend_top = n_rows + 0.5 + vert_extend,
  # bottom horizontal
  x_bottom = 0.5 - 0.3, xend_bottom = 0.5 - 0.3 + hor_arm,
  y_bottom = 0.5 - vert_extend, yend_bottom = 0.5 - vert_extend
)

# Right bracket `]`
right_bracket = tibble(
  # vertical line
  x = n_cols + 0.5 + 0.3, xend = n_cols + 0.5 + 0.3,
  y = 0.5 - vert_extend, yend = n_rows + 0.5 + vert_extend,
  # top horizontal
  x_top = n_cols + 0.5 + 0.3, xend_top = n_cols + 0.5 + 0.3 - hor_arm,
  y_top = n_rows + 0.5 + vert_extend, yend_top = n_rows + 0.5 + vert_extend,
  # bottom horizontal
  x_bottom = n_cols + 0.5 + 0.3, xend_bottom = n_cols + 0.5 + 0.3 - hor_arm,
  y_bottom = 0.5 - vert_extend, yend_bottom = 0.5 - vert_extend
)

# Plot
p2 = ggplot(pred_matrix, aes(x = col, y = row, fill = factor(subj), alpha = alpha)) + 
  geom_tile(color = "grey70", size = 0.5) +
  # Left bracket
  geom_segment(data = left_bracket, aes(x = x, xend = xend, y = y, yend = yend), inherit.aes = FALSE, size = 1) +
  geom_segment(data = left_bracket, aes(x = x_top, xend = xend_top, y = y_top, yend = yend_top), inherit.aes = FALSE, size = 1) +
  geom_segment(data = left_bracket, aes(x = x_bottom, xend = xend_bottom, y = y_bottom, yend = yend_bottom), inherit.aes = FALSE, size = 1) +
  # Right bracket
  geom_segment(data = right_bracket, aes(x = x, xend = xend, y = y, yend = yend), inherit.aes = FALSE, size = 1) +
  geom_segment(data = right_bracket, aes(x = x_top, xend = xend_top, y = y_top, yend = yend_top), inherit.aes = FALSE, size = 1) +
  geom_segment(data = right_bracket, aes(x = x_bottom, xend = xend_bottom, y = y_bottom, yend = yend_bottom), inherit.aes = FALSE, size = 1) +
  theme_minimal(base_family = "Source Sans Pro") +
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank(),
    plot.background = element_rect(fill = "#f6f5f3", color = NA),
    plot.title = element_text(size = 36, face = "bold", hjust = 0.5)
  ) +
  # labs(title = "X") +
  theme(legend.position = "none") + 
  scale_fill_manual(values = c("#E69F00", "#56B4E9", "#009E73")) +
  scale_y_reverse()

p2  = 
  p2 + 
  annotate(geom = "label", x = 5.5, y = 2.5, label = "Predictors from person A", color = "#E69F00", size = 8)  +
  annotate(geom = "label", x = 5.5, y = 7.5, label = "Predictors from person B", color = "#56B4E9", size = 8) +
  annotate(geom = "label", x = 5.5, y = 12.5, label = "Predictors from person C", color = "#009E73", size = 8) 

p2a = arrow_plot + p2 + plot_layout(widths = c(0.1, 0.9))
```

```{r print arrow x }
# p1 + p2a + plot_layout(widths = c(1, 1))

plot_grid(p1, p2a, ncol = 2, align = "v", rel_widths = c(1,1))

```

---


### Details of the method

::: {.incremental}

**For each second and each person**: 

+ Obtain joint distribution of acceleration and lag acceleration for a series of lags 

+ Calculate scalar summaries of the joint distribution 
  
+ We walk through the process for one second, person, and lag to illustrate the process
  
::: 

--- 

### Obtain joint distribution of acceleration and lag acceleration 

```{r jdist accel only}
#| cache: true
p = df %>% 
  ggplot() +
  geom_line(aes(x = time, y = vm), 
    linewidth = .9) +
  geom_point(aes(x = time, y = vm), color = "black") +
  labs(x = "Time (s)", y = "Acceleration (g)") +
  theme(
    legend.position = c(0.2, 0.9),
    legend.title = element_blank(),
    panel.grid = element_blank(),
    legend.background = element_rect(fill = "#f6f5f3", color = "#f6f5f3")
  ) +
  guides(color = guide_legend(nrow = 1)) +
  scale_x_continuous(breaks=c(seq(0, 1, 0.15), 1))

plot_grid(p, p_empty, ncol = 1, align = "h", rel_heights = c(1,1))

```

---

### Obtain joint distribution of acceleration and lag acceleration 

```{r jdistorig}
#| cache: true
p = ggplot() +
  geom_line(
    data = df %>% pivot_longer(
      cols = c(vm, lag_vm),
      names_to = "variable",
      values_to = "value"
    ) %>%
      mutate(variable = factor(variable, levels = c("vm", "lag_vm"))),
    aes(
      x = time,
      y = value,
      color = variable,
      linetype = variable
    ),
    linewidth = .9
  ) +
  geom_point(
    data = df %>% pivot_longer(
      cols = c(vm, lag_vm),
      names_to = "variable",
      values_to = "value"
    ) %>%
      mutate(variable = factor(variable, levels = c("vm", "lag_vm"))),
    aes(x = time, y = value, color = variable)
  ) +
  scale_color_manual(
    values = c("black", "darkgrey"),
    labels = c("Acceleration", "0.15s lagged acceleration"),
    name = ""
  ) +   scale_linetype_manual(
    values = c("solid", "dashed"),
    labels = c("Acceleration", "0.15s lagged acceleration"),
    name = ""
  ) +
  labs(x = "Time (s)", y = "Acceleration (g)") +
  theme(
    legend.position = c(0.2, 0.9),
    legend.title = element_blank(),
    panel.grid = element_blank(),
    legend.background = element_rect(fill = "#f6f5f3", color = "#f6f5f3")
  ) +
  guides(color = guide_legend(nrow = 1)) +
  scale_x_continuous(breaks=c(seq(0, 1, 0.15), 1))

plot_grid(p, p_empty, ncol = 1, align = "h", rel_heights = c(1,1))

```

---

### Obtain joint distribution of acceleration and lag acceleration 


```{r joint dist 1pt}
#| cache: true
points = df %>% 
  pivot_longer(
    cols = c(vm, lag_vm),
    names_to = "variable",
    values_to = "value") %>% 
  select(time, value, variable) %>% filter(round(time, 2) == .150)
p = ggplot() +
  geom_line(
    data = df %>% pivot_longer(
      cols = c(vm, lag_vm),
      names_to = "variable",
      values_to = "value"
    ) %>%
      mutate(variable = factor(variable, levels = c("vm", "lag_vm"))),
    aes(
      x = time,
      y = value,
      color = variable,
      linetype = variable
    ),
    linewidth = .9
  ) +
  geom_point(
    data = df %>% pivot_longer(
      cols = c(vm, lag_vm),
      names_to = "variable",
      values_to = "value"
    ) %>%
      mutate(variable = factor(variable, levels = c("vm", "lag_vm"))),
    aes(x = time, y = value, color = variable)
  ) +
  scale_color_manual(
    values = c("black", "darkgrey"),
    labels = c("Acceleration", "0.15s lagged acceleration"),
    name = ""
  ) +   scale_linetype_manual(
    values = c("solid", "dashed"),
    labels = c("Acceleration", "0.15s lagged acceleration"),
    name = ""
  ) +
  labs(x = "Time (s)", y = "Acceleration (g)") +
  theme(
    legend.position = c(0.2, 0.9),
    legend.title = element_blank(),
    panel.grid = element_blank(),
    legend.background = element_rect(fill = "#f6f5f3", color = "#f6f5f3")
  ) +
  guides(color = guide_legend(nrow = 1)) +
  annotate(
    geom = "point",
    x = points$time[1],
    y = points$value[1],
    color =  "#56B4E9",
    size = 3.5
  ) +
  annotate(
    geom = "point",
    x = points$time[2],
    y = points$value[2],
    color = "#56B4E9",
    size = 3.5
  ) +
  scale_x_continuous(breaks=c(seq(0, 1, 0.15), 1))

p1 = df %>%
  filter(!is.na(lag_vm)) %>%
  slice(1) %>%
  ggplot(aes(x = vm, y = lag_vm)) +
  geom_point(aes(group = time), size = 3.5, color = "#56B4E9") +
  annotate(geom = "label", x = points$value[1], y = points$value[2],
           label = "First acceleration,\nlag acceleration pair",
           vjust = 1, hjust = -.1, size = 3) +
  scale_x_continuous(limits = c(0.4, 2.6)) +
  scale_y_continuous(limits = c(0.4, 2.6)) +
  labs(x = "Acceleration (g)", y = "Lagged acceleration (g)") +
  theme(panel.grid = element_blank())

plot_grid(p, p1, ncol = 1, align = "h", rel_heights = c(1,1))

```



---

### Obtain joint distribution of acceleration and lag acceleration 


```{r joint dist pts}
#| cache: true
points = df %>% 
  pivot_longer(
    cols = c(vm, lag_vm),
    names_to = "variable",
    values_to = "value") %>% 
  select(time, value, variable) %>% 
  filter(round(time, 2) == .150 | round(time, 2) == .160)
p = ggplot() +
  geom_line(
    data = df %>% pivot_longer(
      cols = c(vm, lag_vm),
      names_to = "variable",
      values_to = "value"
    ) %>%
      mutate(variable = factor(variable, levels = c("vm", "lag_vm"))),
    aes(
      x = time,
      y = value,
      color = variable,
      linetype = variable
    ),
    linewidth = .9
  ) +
  geom_point(
    data = df %>% pivot_longer(
      cols = c(vm, lag_vm),
      names_to = "variable",
      values_to = "value"
    ) %>%
      mutate(variable = factor(variable, levels = c("vm", "lag_vm"))),
    aes(x = time, y = value, color = variable)
  ) +
  scale_color_manual(
    values = c("black", "darkgrey"),
    labels = c("Acceleration", "0.15s lagged acceleration"),
    name = ""
  ) + scale_linetype_manual(
    values = c("solid", "dashed"),
    labels = c("Acceleration", "0.15s lagged acceleration"),
    name = ""
  ) +
  labs(x = "Time (s)", y = "Acceleration (g)") +
  theme(
    legend.position = c(0.2, 0.9),
    legend.title = element_blank(),
    panel.grid = element_blank(),
    legend.background = element_rect(fill = "#f6f5f3", color = "#f6f5f3")
  ) +
  scale_x_continuous(breaks=c(seq(0, 1, 0.15), 1)) +
  guides(color = guide_legend(nrow = 1)) +
  annotate(
    geom = "point",
    x = points$time[1],
    y = points$value[1],
    color = "#56B4E9",
    size = 3.5
  ) +
  annotate(
    geom = "point",
    x = points$time[2],
    y = points$value[2],
    color = "#56B4E9",
    size = 3.5
  ) +
  annotate(
    geom = "point",
    x = points$time[3],
    y = points$value[3],
    color = "#D55E00",
    size = 3.5
  ) +
  annotate(
    geom = "point",
    x = points$time[4],
    y = points$value[4],
    color = "#D55E00",
    size = 3.5
  )

p1 = df %>%
  ggplot(aes(x = vm, y = lag_vm)) +
  annotate(geom = "point", x = 0.622, y = 1.26, size = 3.5, color = "#56B4E9") +
  annotate(geom = "point", x = 0.613, y = 1.19, size = 3.5, color = "#D55E00") +
  annotate(geom = "label", x = points$value[3], y = points$value[4],
           label = "Second acceleration,\nlag acceleration pair",
           vjust = 1, hjust = -.1, size = 3) +
  scale_x_continuous(limits = c(0.4, 2.6)) +
  scale_y_continuous(limits = c(0.4, 2.6)) +
  labs(x = "Acceleration (g)", y = "Lagged acceleration (g)") +
  theme(panel.grid = element_blank())
plot_grid(p, p1, ncol = 1, align = "h", rel_heights = c(1,1))

```

---

### Obtain joint distribution of acceleration and lag acceleration 


```{r joint dist 00}
#| cache: true
blue_pts = 
  df %>%
  filter(!is.na(lag_vm)) %>%
  slice(1)

or_pts = 
  df %>%
  filter(!is.na(lag_vm)) %>%
  slice(2)

p1 = df %>%
  filter(!is.na(lag_vm)) %>%
  ggplot(aes(x = vm, y = lag_vm)) +
  geom_point(color = "#383838") + 
  geom_point(data = blue_pts, aes(group = time), color = "#56B4E9", size = 3.5) +
  geom_point(data = or_pts, aes(group = time), color = "#D55E00", size = 3.5) +
  scale_x_continuous(limits = c(0.4, 2.6)) +
  scale_y_continuous(limits = c(0.4, 2.6)) +
  labs(x = "Acceleration (g)", y = "Lagged acceleration (g)") +
  theme(panel.grid = element_blank()) +
  annotate(geom = "label", x = 1.5, y = 2,
           label = "All acceleration,\nlag acceleration pairs",
           vjust = 1, hjust = -.1, size = 3) 

plot_grid(p, p1, ncol = 1, align = "h", rel_heights = c(1,1))

```

---

### Obtain joint distribution of acceleration and lag acceleration 


<img src="figs/p1a_v2.gif" class="gif-stack">
<img src="figs/p2a.gif" class="gif-stack">

---

### Derive predictors from joint distribution 

```{r joint dist 0}
#| cache: true
extra = 
  expand_grid(
    vm = seq(0, 3, 0.1), 
    lag_vm = seq(0, 3, 0.1)) %>%
  mutate(
    vm = cut(vm, breaks = seq(0, 3, 0.25), include.lowest = TRUE),
    lag_vm = cut(lag_vm, breaks = seq(0, 3, 0.25), include.lowest = TRUE),
    n = 0, 
    grp = paste0(vm, "_", lag_vm))
         
count_df = 
  df %>%
  drop_na() %>% 
  mutate(vm = cut(vm, breaks=seq(0, 3, 0.25), include.lowest = TRUE),
         lag_vm = cut(lag_vm, breaks = seq(0, 3, 0.25), include.lowest = TRUE)) %>% 
  group_by(vm, lag_vm) %>% 
  count() %>% 
  mutate(grp =paste0(vm, "_", lag_vm))

plot_df = 
  count_df %>% 
  bind_rows(extra %>% filter(!(grp %in% count_df$grp))) 
  
plot_df2 = plot_df %>% rename(cat_vm = vm, cat_lag_vm = lag_vm) %>% 
  mutate(xmin = sub(".*\\((.+)\\,.*", "\\1", cat_vm),
         xmax = sub(".*\\,(.+)\\].*", "\\1", cat_vm),
         ymin = sub(".*\\((.+)\\,.*", "\\1", cat_lag_vm),
         ymax = sub(".*\\,(.+)\\].*", "\\1", cat_lag_vm)) %>% 
  mutate(across(contains("min") | contains("max"), as.numeric)) %>% 
  mutate(xmin = if_else(is.na(xmin), 0, xmin),
         ymin = if_else(is.na(ymin), 0, ymin))
         

df %>%
  ggplot() +
  geom_point(aes(x = vm, y = lag_vm), size = 1.5) +
  scale_x_continuous(limits = c(0, 3), breaks = seq(0, 3, 0.25)) +
  scale_y_continuous(limits = c(0, 3), breaks = seq(0, 3, 0.25)) +
  labs(x = "Acceleration (g)", y = "Lagged acceleration (g)") +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank()) + 
  geom_rect(data = plot_df2, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax), color = "darkgrey", fill = "transparent")
  
```

---

### Derive predictors from joint distribution 

```{r jointdist0}
df %>%
  ggplot() +
  annotate(geom = "rect", 
           xmin = 0.75, xmax = 1, ymin = 1.5, ymax = 1.75, 
           col = NA, fill = "#F0E442") +
  annotate(geom = "text", x = .86, y = 1.69, label = "n=2", size = 3) +
  geom_point(aes(x = vm, y = lag_vm), size = 1.5) + 
  scale_x_continuous(limits = c(0, 3), breaks = seq(0, 3, 0.25)) +
  scale_y_continuous(limits = c(0, 3), breaks = seq(0, 3, 0.25)) +
  labs(x = "Acceleration (g)", y = "Lagged acceleration (g)") +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank()) + 
  geom_rect(data = plot_df2, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax), color = "darkgrey", fill = "transparent") 
```

---

### Derive predictors from joint distribution 


```{r jointdist}
#| cache: true
df %>%
  ggplot() +
  annotate(geom = "rect", 
           xmin = 0.75, xmax = 1.25, ymin = 1.5, ymax = 1.75,
           col = NA, fill = "#F0E442") +
  annotate(geom = "text", x = .86, y = 1.69, label = "n=2", size = 3) +
  annotate(geom = "text", x = 1.1, y = 1.6, label = "n=3", size = 3)  +
  geom_point(aes(x = vm, y = lag_vm), size = 1.5) + 
  scale_x_continuous(limits = c(0, 3), breaks = seq(0, 3, 0.25)) +
  scale_y_continuous(limits = c(0, 3), breaks = seq(0, 3, 0.25)) +
  labs(x = "Acceleration (g)", y = "Lagged acceleration (g)") +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank()) + 
  geom_rect(data = plot_df2, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax), color = "darkgrey", fill = "transparent") 

```

---

### Derive predictors from joint distribution 


```{r joint dist}
#| cache: true
p = df %>%
  mutate(cat_vm = cut(vm, breaks=seq(0, 3, 0.25), include.lowest = TRUE),
         cat_lag_vm = cut(lag_vm, breaks = seq(0, 3, 0.25), include.lowest = TRUE)) %>% 
  ggplot() +
  geom_rect(data = plot_df2, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax,
                                 fill = n), color = "darkgrey") +
  labs(x = "Acceleration (g)", y = "Lagged acceleration (g)") + 
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "none") + 
  scale_x_continuous(limits = c(0, 3), breaks = seq(0, 3, 0.25)) +
  scale_y_continuous(limits = c(0, 3), breaks = seq(0, 3, 0.25)) +
  scale_fill_viridis(limits = c(0.0001, 19), option = "B") + 
  geom_text(data = plot_df2 %>% filter(n > 0) %>% 
              mutate(tcol = if_else(n >= 11, 0, 1)), 
              aes(color = factor(tcol), x = xmin + 0.125, y = ymin + 0.125, label = n), size = 5) +
  scale_color_manual(values = c("black", "white")) +
  geom_point(aes(x = vm, y = lag_vm), color = "#f6f5f3", alpha = 0.5)

p_nopts = 
  df %>%
  mutate(cat_vm = cut(vm, breaks=seq(0, 3, 0.25), include.lowest = TRUE),
         cat_lag_vm = cut(lag_vm, breaks = seq(0, 3, 0.25), include.lowest = TRUE)) %>% 
  ggplot() +
  geom_point(aes(x = vm, y = lag_vm), color = "#f6f5f3", alpha = 0.5) +
  geom_rect(data = plot_df2, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax,
                                 fill = n), color = "darkgrey") +
  labs(x = "Acceleration (g)", y = "Lagged acceleration (g)") + 
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        # axis.text.y  = element_text(margin = margin(l = -20, unit = "pt")),
        legend.position = "none") + 
  scale_x_continuous(limits = c(0, 3), breaks = seq(0, 3, 0.25)) +
  scale_y_continuous(limits = c(0, 3), breaks = seq(0, 3, 0.25)) +
  scale_fill_viridis(limits = c(0.0001, 19), option = "B") + 
  geom_text(data = plot_df2 %>% filter(n > 0) %>% 
              mutate(tcol = if_else(n >= 11, 0, 1)), 
              aes(color = factor(tcol), x = xmin + 0.125, y = ymin + 0.125, label = n), size = 5) +
  scale_color_manual(values = c("black", "white")) 

p


```

---

### Derive predictors from joint distribution 


```{r grid to matrix}
#| cache: true
n_rows = 10
n_cols = 29
counts = c(0, 0, 4, 11, 7, 6, 0, 0, 2, 2, 0, 0, 7, 0, 2, 9, 2, 11, 0, 1, 2, 2, 3, 7, 0, 2,5,0,0)
# Create a dummy data frame for tiles
pred_matrix = expand_grid(
  row = 1:n_rows,
  col = 1:n_cols
)  %>% 
  mutate(n = c(counts, rep(Inf, (n_rows * n_cols) - n_cols)))

# Bracket offsets
vert_extend = 1.0   # how far the vertical line extends beyond top/bottom
hor_arm = 0.4       # horizontal arm length

# Left bracket `[`
left_bracket = tibble(
  # vertical line
  x = 0.5 - 0.3, xend = 0.5 - 0.3,
  y = 0.5 - vert_extend, yend = n_rows + 0.5 + vert_extend,
  # top horizontal
  x_top = 0.5 - 0.3, xend_top = 0.5 - 0.3 + hor_arm,
  y_top = n_rows + 0.5 + vert_extend, yend_top = n_rows + 0.5 + vert_extend,
  # bottom horizontal
  x_bottom = 0.5 - 0.3, xend_bottom = 0.5 - 0.3 + hor_arm,
  y_bottom = 0.5 - vert_extend, yend_bottom = 0.5 - vert_extend
)

# Right bracket `]`
right_bracket = tibble(
  # vertical line
  x = n_cols + 0.5 + 0.3, xend = n_cols + 0.5 + 0.3,
  y = 0.5 - vert_extend, yend = n_rows + 0.5 + vert_extend,
  # top horizontal
  x_top = n_cols + 0.5 + 0.3, xend_top = n_cols + 0.5 + 0.3 - hor_arm,
  y_top = n_rows + 0.5 + vert_extend, yend_top = n_rows + 0.5 + vert_extend,
  # bottom horizontal
  x_bottom = n_cols + 0.5 + 0.3, xend_bottom = n_cols + 0.5 + 0.3 - hor_arm,
  y_bottom = 0.5 - vert_extend, yend_bottom = 0.5 - vert_extend
)

pred_matrix$z_plot = ifelse(is.infinite(pred_matrix$n), max(pred_matrix$n[is.finite(pred_matrix$n)], na.rm = TRUE), pred_matrix$n)


# Plot
p2 = ggplot(pred_matrix, aes(x = col, y = row, fill = z_plot)) + 
  geom_tile(color = "#f6f5f3", linewidth = 0.5, size = .5) +
  # Left bracket
  geom_segment(data = left_bracket, aes(x = x, xend = xend, y = y, yend = yend), inherit.aes = FALSE, size = 1) +
  geom_segment(data = left_bracket, aes(x = x_top, xend = xend_top, y = y_top, yend = yend_top), inherit.aes = FALSE, size = 1) +
  geom_segment(data = left_bracket, aes(x = x_bottom, xend = xend_bottom, y = y_bottom, yend = yend_bottom), inherit.aes = FALSE, size = 1) +
  # Right bracket
  geom_segment(data = right_bracket, aes(x = x, xend = xend, y = y, yend = yend), inherit.aes = FALSE, size = 1) +
  geom_segment(data = right_bracket, aes(x = x_top, xend = xend_top, y = y_top, yend = yend_top), inherit.aes = FALSE, size = 1) +
  geom_segment(data = right_bracket, aes(x = x_bottom, xend = xend_bottom, y = y_bottom, yend = yend_bottom), inherit.aes = FALSE, size = 1) +
  scale_fill_viridis(option = "B", limits = c(0.0001, 19)) +
  theme_minimal(base_family = "Source Sans Pro") +
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank(),
    plot.background = element_rect(fill = "#f6f5f3", color = NA),
    plot.title = element_text(size = 36, face = "bold", hjust = 0.5)
  ) +
  theme(legend.position = "none") + 
  scale_y_reverse() +
  geom_tile(data = subset(pred_matrix, is.infinite(n)), fill = "#f6f5f3")
```

```{r ap}
arrow_plot = ggplot() +
  xlim(0,1) + ylim(0,.5) +
  annotate(
    "segment",
    y = .5, yend = 0, x = 0.5, xend = 0.5,
    arrow = arrow(length = unit(0.1, "inches"), type = "closed"),
    color = "#D55E00", size = 1
  ) +
  theme_void()+
  theme(plot.background = element_rect(fill = "#f6f5f3"))
```

```{r ap2}
p_nopts  / arrow_plot  / p2 + plot_layout(ncol = 1, heights = c(1, 0.2, 1))

```

---

### Repeat for multiple lags

```{r repeat mult lags}
#| cache: true
# this will be two panel plot with second 1 and second 2 on top 
count_dfl2 = 
  df30 %>%
  drop_na() %>% 
  mutate(vm = cut(vm, breaks=seq(0, 3, 0.25), include.lowest = TRUE),
         lag_vm = cut(lag_vm, breaks = seq(0, 3, 0.25), include.lowest = TRUE)) %>% 
  group_by(vm, lag_vm) %>% 
  count() %>% 
  mutate(grp =paste0(vm, "_", lag_vm))

plot_dfl2 = 
  count_dfl2 %>% 
  bind_rows(extra %>% filter(!(grp %in% count_dfl2$grp))) 
  
combo_df = plot_df %>% mutate(lag = "Lag = 0.15s") %>% 
  bind_rows(plot_dfl2 %>% mutate(lag = "Lag = 0.30s")) 
pv2l = combo_df %>% 
  ggplot(aes(x = vm, y = lag_vm, label = n)) + 
  geom_tile(col = "darkgrey", aes(fill = n)) + 
  scale_fill_viridis(limits = c(0.0001, 19), option = "B") + 
  facet_grid(.~lag) + 
  geom_text(data = combo_df %>% filter(n > 0) %>% 
              mutate(tcol = if_else(n >= 11, 0, 1)), 
              aes(color = factor(tcol))) +
  scale_color_manual(values = c("black", "white")) +
  theme(legend.position = "none",
        axis.text = element_blank(),
        plot.title = element_text(size = 12, face = "plain")) + 
  labs(x = "Acceleration (g)", y = "Lagged acceleration (g)") 

pv2la = combo_df %>% 
  ggplot(aes(x = vm, y = lag_vm, label = n)) + 
  geom_tile(col = "black", aes(fill = n)) + 
  scale_fill_viridis(limits = c(0.0001, 19), option = "B") + 
  facet_grid(.~lag) + 
  theme(legend.position = "none",
        axis.text = element_blank(),
        plot.title = element_text(size = 12, face = "plain")) + 
  labs(x = "Acceleration (g)", y = "Lagged acceleration (g)", title = "Second 1") 
```

```{r mult lags pred mat}
#| cache: true
n_rows = 10
n_cols = 29 * 2 
counts = c(0, 6, 7, 11, 4, 0, 0, 7, 0, 2, 2, 0, 11, 2, 9, 0, 3, 0, 7, 3, 2, 2, 1,
           0, 5, 2, 0, 0, 0,
           0, 0, 6, 4, 6, 0, 0, 3, 5, 0, 0, 0, 14, 2, 5, 4, 0, 0, 10, 4, 1, 0, 0, 6, 1, 0, 0, 0, 0)
  
 
# Create a dummy data frame for tiles
pred_matrix = expand_grid(
  row = 1:n_rows,
  col = 1:n_cols
)  %>% 
  mutate(n = c(counts, rep(Inf, (n_rows * n_cols) - (n_cols))))

# Bracket offsets
vert_extend = 1.0   # how far the vertical line extends beyond top/bottom
hor_arm = 0.4       # horizontal arm length

# Left bracket `[`
left_bracket = tibble(
  # vertical line
  x = 0.5 - 0.3, xend = 0.5 - 0.3,
  y = 0.5 - vert_extend, yend = n_rows + 0.5 + vert_extend,
  # top horizontal
  x_top = 0.5 - 0.3, xend_top = 0.5 - 0.3 + hor_arm,
  y_top = n_rows + 0.5 + vert_extend, yend_top = n_rows + 0.5 + vert_extend,
  # bottom horizontal
  x_bottom = 0.5 - 0.3, xend_bottom = 0.5 - 0.3 + hor_arm,
  y_bottom = 0.5 - vert_extend, yend_bottom = 0.5 - vert_extend
)

# Right bracket `]`
right_bracket = tibble(
  # vertical line
  x = n_cols + 0.5 + 0.3, xend = n_cols + 0.5 + 0.3,
  y = 0.5 - vert_extend, yend = n_rows + 0.5 + vert_extend,
  # top horizontal
  x_top = n_cols + 0.5 + 0.3, xend_top = n_cols + 0.5 + 0.3 - hor_arm,
  y_top = n_rows + 0.5 + vert_extend, yend_top = n_rows + 0.5 + vert_extend,
  # bottom horizontal
  x_bottom = n_cols + 0.5 + 0.3, xend_bottom = n_cols + 0.5 + 0.3 - hor_arm,
  y_bottom = 0.5 - vert_extend, yend_bottom = 0.5 - vert_extend
)

pred_matrix$z_plot = ifelse(is.infinite(pred_matrix$n), max(pred_matrix$n[is.finite(pred_matrix$n)], na.rm = TRUE), pred_matrix$n)


# Plot
p2 = ggplot(pred_matrix, aes(x = col, y = row, fill = z_plot)) + 
  geom_tile(color = "#f6f5f3", linewidth = 0.5, size = .5) +
  # Left bracket
  geom_segment(data = left_bracket, aes(x = x, xend = xend, y = y, yend = yend), inherit.aes = FALSE, size = 1) +
  geom_segment(data = left_bracket, aes(x = x_top, xend = xend_top, y = y_top, yend = yend_top), inherit.aes = FALSE, size = 1) +
  geom_segment(data = left_bracket, aes(x = x_bottom, xend = xend_bottom, y = y_bottom, yend = yend_bottom), inherit.aes = FALSE, size = 1) +
  # Right bracket
  geom_segment(data = right_bracket, aes(x = x, xend = xend, y = y, yend = yend), inherit.aes = FALSE, size = 1) +
  geom_segment(data = right_bracket, aes(x = x_top, xend = xend_top, y = y_top, yend = yend_top), inherit.aes = FALSE, size = 1) +
  geom_segment(data = right_bracket, aes(x = x_bottom, xend = xend_bottom, y = y_bottom, yend = yend_bottom), inherit.aes = FALSE, size = 1) +
  scale_fill_viridis(option = "B", limits = c(0.0001, 19)) +
  theme_minimal(base_family = "Source Sans Pro") +
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank(),
    plot.background = element_rect(fill = "#f6f5f3", color = NA),
    plot.title = element_text(size = 36, face = "bold", hjust = 0.5)
  ) +
  theme(legend.position = "none") + 
  scale_y_reverse() +
  geom_tile(data = subset(pred_matrix, is.infinite(n)), fill = "#f6f5f3")

p2 = p2 + 
  annotate(geom = "text", x = n_cols/ 4, y = -.5, label = "Lag = 0.15s", size = 4) +
  annotate(geom = "text", x = (n_cols / 2) +( n_cols/ 4), y = -.5, label = "Lag = 0.30s", size = 4) 
```

```{r mult lags print}
pv2l / arrow_plot  / p2 + plot_layout(ncol = 1, heights = c(1, 0.2, 1))
```

----

### Repeat for multiple seconds 

```{r repeat all seconds}
#| cache: true
# this will be two panel plot with second 1 and second 2 on top 
count_df2 = 
  df2 %>%
  drop_na() %>% 
  mutate(vm = cut(vm, breaks=seq(0, 3, 0.25), include.lowest = TRUE),
         lag_vm = cut(lag_vm, breaks = seq(0, 3, 0.25), include.lowest = TRUE)) %>% 
  group_by(vm, lag_vm) %>% 
  count() %>% 
  mutate(grp =paste0(vm, "_", lag_vm))

plot_df2 = 
  count_df2 %>% 
  bind_rows(extra %>% filter(!(grp %in% count_df2$grp))) 

count_df2l2 = 
  df2_30 %>%
  drop_na() %>% 
  mutate(vm = cut(vm, breaks=seq(0, 3, 0.25), include.lowest = TRUE),
         lag_vm = cut(lag_vm, breaks = seq(0, 3, 0.25), include.lowest = TRUE)) %>% 
  group_by(vm, lag_vm) %>% 
  count() %>% 
  mutate(grp =paste0(vm, "_", lag_vm))

plot_df2l2 = 
  count_df2l2 %>% 
  bind_rows(extra %>% filter(!(grp %in% count_df2l2$grp))) 

combo_df2 = 
  plot_df2 %>% mutate(lag = "Lag = 0.15s") %>% 
  bind_rows(plot_df2l2 %>% mutate(lag = "Lag = 0.30s"))
pv2 = combo_df2 %>% 
  ggplot(aes(x = vm, y = lag_vm, label = n)) + 
  geom_tile(col = "darkgrey", aes(fill = n)) + 
  scale_fill_viridis(limits = c(0.0001, 19), option = "B") + 
  geom_text(data = combo_df2 %>% filter(n > 0) %>% 
              mutate(tcol = if_else(n >= 11, 0, 1)), 
              aes(color = factor(tcol))) +
  scale_color_manual(values = c("black", "white")) +
  theme(legend.position = "none",
        axis.text = element_blank(),
        plot.title = element_text(size = 12, face = "plain")) + 
  facet_grid(.~lag) + 
  labs(x = "Acceleration (g)", y = "Lagged acceleration (g)", title = "Second 2") 

pv2a = combo_df2 %>% 
  ggplot(aes(x = vm, y = lag_vm, label = n)) + 
  geom_tile(col = "black", aes(fill = n)) + 
  scale_fill_viridis(limits = c(0.0001, 19), option = "B") + 
  theme(legend.position = "none",
        axis.text = element_blank(),
        plot.title = element_text(size = 12, face = "plain")) + 
  facet_grid(.~lag) + 
  labs(x = "Acceleration (g)", y = "Lagged acceleration (g)", title = "Second 2") 

```

```{r repeat seconds}
#| cache: true
n_rows = 10
n_cols = 29 * 2
counts = c(0, 6, 7, 11, 4, 0, 0, 7, 0, 2, 2, 0, 11, 2, 9, 0, 3, 0, 7, 3, 2, 2, 1,
           0, 5, 2, 0, 0, 0,
           0, 0, 6, 4, 6, 0, 0, 3, 5, 0, 0, 0, 14, 2, 5, 4, 0, 0, 10, 4, 1, 0, 0, 6, 1, 0, 0, 0, 0,
           0, 0, 12, 9, 8, 4, 0, 0, 2, 2, 0, 8, 0, 11, 1, 3, 0, 3, 0, 6, 5, 2, 2, 1, 0, 5,2,0,0, 
           0, 0, 4, 11, 7, 6, 0, 0, 2, 2, 0, 0, 7, 0, 2, 9, 2, 11, 0, 1, 2, 2, 3, 7, 0, 2,5,0,0)
# Create a dummy data frame for tiles
pred_matrix = expand_grid(
  row = 1:n_rows,
  col = 1:n_cols
)  %>% 
  mutate(n = c(counts, rep(Inf, (n_rows * n_cols) - (2*n_cols))))

# Bracket offsets
vert_extend = 1.0   # how far the vertical line extends beyond top/bottom
hor_arm = 0.4       # horizontal arm length

# Left bracket `[`
left_bracket = tibble(
  # vertical line
  x = 0.5 - 0.3, xend = 0.5 - 0.3,
  y = 0.5 - vert_extend, yend = n_rows + 0.5 + vert_extend,
  # top horizontal
  x_top = 0.5 - 0.3, xend_top = 0.5 - 0.3 + hor_arm,
  y_top = n_rows + 0.5 + vert_extend, yend_top = n_rows + 0.5 + vert_extend,
  # bottom horizontal
  x_bottom = 0.5 - 0.3, xend_bottom = 0.5 - 0.3 + hor_arm,
  y_bottom = 0.5 - vert_extend, yend_bottom = 0.5 - vert_extend
)

# Right bracket `]`
right_bracket = tibble(
  # vertical line
  x = n_cols + 0.5 + 0.3, xend = n_cols + 0.5 + 0.3,
  y = 0.5 - vert_extend, yend = n_rows + 0.5 + vert_extend,
  # top horizontal
  x_top = n_cols + 0.5 + 0.3, xend_top = n_cols + 0.5 + 0.3 - hor_arm,
  y_top = n_rows + 0.5 + vert_extend, yend_top = n_rows + 0.5 + vert_extend,
  # bottom horizontal
  x_bottom = n_cols + 0.5 + 0.3, xend_bottom = n_cols + 0.5 + 0.3 - hor_arm,
  y_bottom = 0.5 - vert_extend, yend_bottom = 0.5 - vert_extend
)

pred_matrix$z_plot = ifelse(is.infinite(pred_matrix$n), max(pred_matrix$n[is.finite(pred_matrix$n)], na.rm = TRUE), pred_matrix$n)


# Plot
p2 = ggplot(pred_matrix, aes(x = col, y = row, fill = z_plot)) + 
  geom_tile(color = "#f6f5f3", linewidth = 0.5, size = .5) +
  # Left bracket
  geom_segment(data = left_bracket, aes(x = x, xend = xend, y = y, yend = yend), inherit.aes = FALSE, size = 1) +
  geom_segment(data = left_bracket, aes(x = x_top, xend = xend_top, y = y_top, yend = yend_top), inherit.aes = FALSE, size = 1) +
  geom_segment(data = left_bracket, aes(x = x_bottom, xend = xend_bottom, y = y_bottom, yend = yend_bottom), inherit.aes = FALSE, size = 1) +
  # Right bracket
  geom_segment(data = right_bracket, aes(x = x, xend = xend, y = y, yend = yend), inherit.aes = FALSE, size = 1) +
  geom_segment(data = right_bracket, aes(x = x_top, xend = xend_top, y = y_top, yend = yend_top), inherit.aes = FALSE, size = 1) +
  geom_segment(data = right_bracket, aes(x = x_bottom, xend = xend_bottom, y = y_bottom, yend = yend_bottom), inherit.aes = FALSE, size = 1) +
  scale_fill_viridis(option = "B", limits = c(0.0001, 19)) +
  theme_minimal(base_family = "Source Sans Pro") +
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank(),
    plot.background = element_rect(fill = "#f6f5f3", color = NA),
    plot.title = element_text(size = 36, face = "bold", hjust = 0.5)
  ) +
  theme(legend.position = "none") + 
  scale_y_reverse() +
  geom_tile(data = subset(pred_matrix, is.infinite(n)), fill = "#f6f5f3")

p2  = p2 +
  annotate(geom = "text", x = n_cols/ 4, y = -.5, label = "Lag = 0.15s", size = 4) +
  annotate(geom = "text", x = (n_cols / 2) +( n_cols/ 4), y = -.5, label = "Lag = 0.30s", size = 4) +
  annotate(geom = "text", x = -1.5, y = 1, label = "Sec 1", size = 4) +
  annotate(geom = "text", x = -1.5, y = 2, label = "Sec 2", size = 4) +
  annotate(geom = "text", x = n_cols + 2.5, y = 1, label = "Sec 1", size = 4) +
  annotate(geom = "text", x = n_cols + 2.5, y = 2, label = "Sec 2", size = 4) 
```

```{r repeat seconds print}
pv2l = pv2l + labs(title = "Second 1")
(pv2l + pv2 + plot_layout(axes = "collect")) / arrow_plot  / p2 + plot_layout(ncol = 1, heights = c(1, 0.2, 1))
```

----

### Fingerprints summarize predictors for a given lag and are different across individuals

```{r fprints 3}
#| cache: true 

s1_dens = 
 dens_df_s2_l15 %>% mutate(lag = "Lag = 0.15s") %>% 
  bind_rows(dens_df_s2_l30 %>% mutate(lag = "Lag = 0.30s"))

s2_dens = 
 dens_df_s4_l15 %>% mutate(lag = "Lag = 0.15s") %>% 
  bind_rows(dens_df_s4_l30 %>% mutate(lag = "Lag = 0.30s"))

s3_dens = 
 dens_df_s6_l15 %>% mutate(lag = "Lag = 0.15s") %>% 
  bind_rows(dens_df_s6_l30 %>% mutate(lag = "Lag = 0.30s"))

s1_dens %>% mutate(id = "Person A") %>% 
  bind_rows(s2_dens %>% mutate(id = "Person B")) %>% 
  bind_rows(s3_dens %>% mutate(id = "Person C")) %>%
  ggplot(aes(x=vm, y=lag_vm, color = density)) +
  geom_point(size = 0.9, alpha = 0.8) +
  facet_grid(id~lag) +
  scale_color_viridis(name = "# points", option = "B") +
  labs(x = "Acceleration (g)", y = "Lagged Acceleration (g)") +
  scale_x_continuous(limits = c(0,3)) +
  scale_y_continuous(limits = c(0,3)) 
```

---

### Ready to fit models


```{r ymat2}
#| cache: true
n_rows = 35
n_cols = 10 

# Create a dummy data frame for tiles
pred_matrix = expand_grid(
  row = 1:n_rows,
  col = 1:n_cols
) %>% 
  mutate(subj = 
           case_when(row %in% c(1:10) ~ 1,
                     row %in% c(11:20) ~ 2,
                     row %in% c(21:30) ~ 3,
                     .default = NA_real_)) %>% 
  rowwise() %>% 
  mutate(alpha = runif(1, 0, 1)) %>% 
  ungroup() %>% 
  mutate(alpha = if_else(row %in% c(31:34), Inf, alpha))

left_bracket = tibble(
  # vertical line
  x = 0.5 - 0.3, xend = 0.5 - 0.3,
  y = 0.5 - vert_extend, yend = n_rows + 0.5 + vert_extend,
  # top horizontal
  x_top = 0.5 - 0.3, xend_top = 0.5 - 0.3 + hor_arm,
  y_top = n_rows + 0.5 + vert_extend, yend_top = n_rows + 0.5 + vert_extend,
  # bottom horizontal
  x_bottom = 0.5 - 0.3, xend_bottom = 0.5 - 0.3 + hor_arm,
  y_bottom = 0.5 - vert_extend, yend_bottom = 0.5 - vert_extend
)

# Right bracket `]`
right_bracket = tibble(
  # vertical line
  x = n_cols + 0.5 + 0.3, xend = n_cols + 0.5 + 0.3,
  y = 0.5 - vert_extend, yend = n_rows + 0.5 + vert_extend,
  # top horizontal
  x_top = n_cols + 0.5 + 0.3, xend_top = n_cols + 0.5 + 0.3 - hor_arm,
  y_top = n_rows + 0.5 + vert_extend, yend_top = n_rows + 0.5 + vert_extend,
  # bottom horizontal
  x_bottom = n_cols + 0.5 + 0.3, xend_bottom = n_cols + 0.5 + 0.3 - hor_arm,
  y_bottom = 0.5 - vert_extend, yend_bottom = 0.5 - vert_extend
)

p3n = ggplot(pred_matrix, aes(x = col, y = row, fill = factor(subj), alpha = alpha)) + 
  geom_tile(color = "#f6f5f3", size = 0.5) +
  # Left bracket
  geom_segment(data = left_bracket, aes(x = x, xend = xend, y = y, yend = yend), inherit.aes = FALSE, size = 1) +
  geom_segment(data = left_bracket, aes(x = x_top, xend = xend_top, y = y_top, yend = yend_top), inherit.aes = FALSE, size = 1) +
  geom_segment(data = left_bracket, aes(x = x_bottom, xend = xend_bottom, y = y_bottom, yend = yend_bottom), inherit.aes = FALSE, size = 1) +
  # Right bracket
  geom_segment(data = right_bracket, aes(x = x, xend = xend, y = y, yend = yend), inherit.aes = FALSE, size = 1) +
  geom_segment(data = right_bracket, aes(x = x_top, xend = xend_top, y = y_top, yend = yend_top), inherit.aes = FALSE, size = 1) +
  geom_segment(data = right_bracket, aes(x = x_bottom, xend = xend_bottom, y = y_bottom, yend = yend_bottom), inherit.aes = FALSE, size = 1) +
  theme_minimal(base_family = "Source Sans Pro") +
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank(),
    plot.background = element_rect(fill = "#f6f5f3", color = NA),
    plot.title = element_text(size = 36, face = "bold", hjust = 0.5)
  ) +
  labs(title = "X") +
  theme(legend.position = "none") + 
  scale_fill_manual(values = c("#E69F00", "#56B4E9", "#009E73")) +
  scale_y_reverse() +
  geom_tile(data = subset(pred_matrix, is.infinite(alpha)), fill = "#f6f5f3") +
  annotate(geom = "text", x = n_cols/2 + .35, y = 32.5, label = "...", size = 8, angle = 90) 



p3n  = p3n +
  annotate(geom = "label", x = 5.5, y = 3, label = "Predictors from person A",
           size = 5, color = "#E69F00") +
  annotate(geom = "label", x = 5.5, y = 14, label = "Predictors from person B", size = 5, color = "#56B4E9") +
  annotate(geom = "label", x = 5.5, y = 23, label = "Predictors from person C", size = 5, color = "#009E73") +
  annotate(geom = "label", x = 5.5, y = 35, label = "Predictors from person n", size = 5) 
```

```{r y matrix updated}
#| cache: true
n_cols = 1
n_rows = 35

pred_matrix = expand_grid(
  row = 1:n_rows,
  col = 1:n_cols
) %>% 
  mutate(subj = 
           case_when(row %in% c(1:10) ~ 1,
                     row %in% c(11:20) ~ 2,
                     row %in% c(21:30) ~ 3,
                     TRUE ~ NA_real_)) 

left_bracket = tibble(
  # vertical line
  x = 0.5 - 0.3, xend = 0.5 - 0.3,
  y = 0.5 - vert_extend, yend = n_rows + 0.5 + vert_extend,
  # top horizontal
  x_top = 0.5 - 0.3, xend_top = 0.5 - 0.3 + hor_arm,
  y_top = n_rows + 0.5 + vert_extend, yend_top = n_rows + 0.5 + vert_extend,
  # bottom horizontal
  x_bottom = 0.5 - 0.3, xend_bottom = 0.5 - 0.3 + hor_arm,
  y_bottom = 0.5 - vert_extend, yend_bottom = 0.5 - vert_extend
)

# Right bracket `]`
right_bracket = tibble(
  # vertical line
  x = n_cols + 0.5 + 0.3, xend = n_cols + 0.5 + 0.3,
  y = 0.5 - vert_extend, yend = n_rows + 0.5 + vert_extend,
  # top horizontal
  x_top = n_cols + 0.5 + 0.3, xend_top = n_cols + 0.5 + 0.3 - hor_arm,
  y_top = n_rows + 0.5 + vert_extend, yend_top = n_rows + 0.5 + vert_extend,
  # bottom horizontal
  x_bottom = n_cols + 0.5 + 0.3, xend_bottom = n_cols + 0.5 + 0.3 - hor_arm,
  y_bottom = 0.5 - vert_extend, yend_bottom = 0.5 - vert_extend
)

p4 = pred_matrix %>% 
  mutate(outcome = case_when(subj == 1 ~ "1",
                             !is.na(subj) ~ "0",
                             is.na(subj) & row == 35 ~ "0",
                             .default = ".")) %>% 
  ggplot(aes(x = col, y = row, label = outcome, color = as.factor(subj))) + 
  geom_tile(color = NA, fill = NA, size = 0.5) +
  # geom_text(size = 3)  +
  scale_color_manual(values = c("#E69F00", "#56B4E9", "#009E73")) +
  geom_segment(data = left_bracket, aes(x = x, xend = xend, y = y, yend = yend), inherit.aes = FALSE, size = 1) +
  geom_segment(data = left_bracket, aes(x = x_top, xend = xend_top, y = y_top, yend = yend_top), inherit.aes = FALSE, size = 1) +
  geom_segment(data = left_bracket, aes(x = x_bottom, xend = xend_bottom, y = y_bottom, yend = yend_bottom), inherit.aes = FALSE, size = 1) +
  # Right bracket
  geom_segment(data = right_bracket, aes(x = x, xend = xend, y = y, yend = yend), inherit.aes = FALSE, size = 1) +
  geom_segment(data = right_bracket, aes(x = x_top, xend = xend_top, y = y_top, yend = yend_top), inherit.aes = FALSE, size = 1) +
  geom_segment(data = right_bracket, aes(x = x_bottom, xend = xend_bottom, y = y_bottom, yend = yend_bottom), inherit.aes = FALSE, size = 1) +
  theme_minimal(base_family = "Source Sans Pro") +
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank(),
    plot.background = element_rect(fill = "#f6f5f3", color = NA),
    plot.title = element_text(size = 36, face = "bold", hjust = 0.5)
  ) +
  labs(title = "Y") +
  theme(legend.position = "none") + 
  scale_y_reverse() 

p4 = 
  p4 +
  annotate(geom = "text", x = 1, y = 7, label = "1", size = 12, color = "#E69F00") +
  annotate(geom = "text", x = 1, y = 15, label = "0", size = 12) +
  annotate(geom = "text", x = 1, y = 19, label = ".", size = 12) +
  annotate(geom = "text", x = 1, y = 21, label = ".", size = 12) +
  annotate(geom = "text", x = 1, y = 23, label = ".", size = 12) +
  annotate(geom = "text", x = 1, y = 30, label = "0", size = 12) 

p4 + p3n + plot_layout(ncol = 2, widths = c(0.3, 1)) 
```

---


### Results 

```{r paper 1 res}
pred_df %>% 
  group_by(true_subject) %>% 
  mutate(max = max(prob)) %>% 
  ungroup() %>% 
  mutate(correct = (prob == max & true_subject == pred_subject) * 1) %>%
  ggplot(aes(x = factor(true_subject), y = prob, color = factor(correct))) + 
  geom_jitter(width = .1, alpha = 0.9) +
  theme(legend.position = "bottom",
        axis.ticks.x = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  scale_color_manual(values = c("#CC79A7", "#009E73"),
                     labels = c("No", "Yes"),
                     name = "Correctly Participant") + 
  labs(x = "Participant", y = "Predicted Probability",
       title = "100% rank-1 accuracy in 32 participants") +
  guides(color = guide_legend(override.aes = list(size = 3, alpha = 1))) +
  scale_y_continuous(breaks = seq(0, 1, 0.1), limits = c(-0.01, 1.01)) +
  annotate(geom = "text",
           color = "#444444",
           hjust = 0,
           label = "Green point above pink points\nin each column indicates\ncorrect identification",
           x = "23", y = 0.8) +
  geom_segment(xend = "22", x = "23", y = 0.8, yend = 0.85,
    arrow = arrow(length = unit(0.05, "inches"), type = "closed"),
    color = "#444444",
    linewidth = .3)

```

<div style=" position: absolute; bottom: 1em; right: -4em; font-size: 0.7em; color: #777; "> @Koffman2023 </div>

---

### Why not use the entire joint distribution? 

#### Functional regression approach 


![](figs/test1.png)

::: footer
Hat tip to [Edward Gunning](https://edwardgunning.github.io/) for the idea for these figures
:::

---

### Why not use the entire joint distribution? 

#### Functional regression approach 

![](figs/test2.png)

::: footer
Hat tip to [Edward Gunning](https://edwardgunning.github.io/) for the idea for these figures
:::
---

### Why not use the entire joint distribution? 

#### Functional regression approach 

![](figs/test3.png)

::: footer
Hat tip to [Edward Gunning](https://edwardgunning.github.io/) for the idea for these figures
:::
---

### Why not use the entire joint distribution? 

#### Functional regression approach 
 
![](figs/test4.png)

::: footer
Hat tip to [Edward Gunning](https://edwardgunning.github.io/) for the idea for these figures
:::

---

### Why not use the entire joint distribution? 

#### Functional regression approach 
 
![](figs/test4.png)

$$\text{logit}(p_{ij}^{i_0}) =\beta_0^{i_0} + \int_{u=1}^S\int_{s=u}^SF_{i_0}\{ v_{ij}(s), v_{ij}(s-u), u\}dsdu $$

$u = 1, \dots, S = 100$ (number of observations per second) 

$v_{ij}(s)$ = acceleration at centisecond $s$ for subject $i$ in second $j$

$F(\cdot, \cdot, \cdot)$: trivariate smooth function 

::: footer
Hat tip to [Edward Gunning](https://edwardgunning.github.io/) for the idea for these figures
:::

---

### Why not use fancier models? 

:::: {.columns}

::: {.column width="55%"}


![](figs/forest.png){width=50%}

![](figs/rocket2.png){width=50%}
:::

::: {.column width="45%"}
Rank-1 (rank-5) % accuracies 

153 person dataset

3 min of walking seach

Two sessions at least 1 week apart 

+ Train and test on session 1
  + Logistic regression: 92 (97) 
  + Machine learning: 93 (99)
  + <span style="color:#009E73;">Functional regression: 98 (100)\%</span>

+ Train on session 1, test on session 2 
  + Logistic regression: 41 (75)
  + <span style="color:#009E73;">Machine learning: 58 (78)</span>
  + Functional regression: 53 (69)
:::
::::

<div style=" position: absolute; bottom: 1em; right: -4em; font-size: 0.7em; color: #777; "> @Koffman2024 </div>

---

## Outline {.question-bullets}

<br>

- Can we identify someone from their walking pattern measured by a wrist-worn accelerometer? *(Digital fingerprinting)*
<br>
$\rightarrow$ Yes! 
- <span style="color:gray;">Can we identify someone from their walking pattern measured by a wrist-worn accelerometer in big, free-living datasets when we don't know when people are walking?</span>
- <span style="color:gray;">Can we accurately find walking and count steps in free-living datasets? </span>
- <span style="color:gray;">Can we generalize conclusions from free-living accelerometry data to the US population?</span> 
- <span style="color:gray;">Can we apply these methods in other, non-accelerometry datasets? </span>


---

## Outline {.question-bullets}

<br>

- <span style="color:gray;">Can we identify someone from their walking pattern measured by a wrist-worn accelerometer? *(Digital fingerprinting)* </span>
<br>
<span style="color:gray;">$\rightarrow$ Yes! </span>
- Can we identify someone from their walking pattern measured by a wrist-worn accelerometer in big, free-living datasets?
- <span style="color:gray;">Can we accurately find walking and count steps in free-living datasets? </span>
- <span style="color:gray;">Can we generalize conclusions from free-living accelerometry data to the US population?</span> 
- <span style="color:gray;">Can we apply these methods in other, non-accelerometry datasets? </span>


---

## Outline {.question-bullets}

<br>

- <span style="color:gray;">Can we identify someone from their walking pattern measured by a wrist-worn accelerometer? *(Digital fingerprinting)* </span>
<br>
<span style="color:gray;">$\rightarrow$ Yes! </span>
- Can we identify someone from their walking pattern measured by a wrist-worn accelerometer in big, free-living datasets?
- Can we accurately find walking and count steps in free-living datasets? 
- <span style="color:gray;">Can we generalize conclusions from free-living accelerometry data to the US population?</span> 
- <span style="color:gray;">Can we apply these methods in other, non-accelerometry datasets? </span>



# Can we accurately find walking and count steps in free-living datasets?

---


### Validation: identifying walking in free-living datasets

5 open source algorithms, 3 datasets with gold-standard step counts 

```{r algo compare}
#| cache: true
p1 = 
  step_acc %>% 
  filter(cat_activity %in% c("clemson_overall", "oxwalk100")) %>% 
  filter(algorithm %in% c("steps_scrf", "steps_vsrres")) %>% 
  ggplot(aes(x = cat_activity, y = f1, color = algorithm)) + 
  geom_boxplot(outlier.shape = NA, position = position_dodge()) + 
  geom_point(position = position_jitterdodge(jitter.width = .15)) +
  labs(x = "", y = "F1 Score", subtitle = "Walking identification accuracy") +
  scale_x_discrete(labels = c("Dataset 1", "Dataset 2")) +
  scale_color_manual(values = c("#E69F00", "#56B4E9"),
                     labels = c("Algorithm 1", "Algorithm 2"),
                     name = "") + 
  theme(legend.position = c(0.2, 0.4))

p1a = step_res %>% 
  filter(cat_activity %in% c("oxwalk100"),
         algorithm %in% c("steps_truth", "steps_scrf", "steps_vsrres")) %>% 
  pivot_wider(names_from = algorithm, values_from = total_steps) %>% 
  pivot_longer(cols = c(steps_vsrres, steps_scrf), names_to = "algo", values_to = "steps") %>% 
  ggplot(aes(x = steps_truth, y = steps, color = algo)) + 
  geom_point(size = 2) + 
  geom_labelabline(slope = 1, label = "y=x line", color = "#444444") +
  labs(x = "True Steps", y = "Algorithm-Estimated Steps", subtitle = "Step count accuracy: Dataset 1") +
  scale_x_continuous(limits = c(0, 6000)) + 
  scale_y_continuous(limits = c(0, 6000)) +
  scale_color_manual(values = c("#E69F00", "#56B4E9"),
                     labels = c("Algorithm 1", "Algorithm 2"),
                     name = "") + 
  theme(legend.position = c(0.8, 0.4))

p1b = step_res %>% 
  filter(cat_activity %in% c("clemson_walk_irregular", "clemson_walk_regular", "clemson_walk_semiregular"),
         algorithm %in% c("steps_truth", "steps_scrf", "steps_vsrres")) %>% 
  pivot_wider(names_from = algorithm, values_from = total_steps) %>% 
  pivot_longer(cols = c(steps_vsrres, steps_scrf), names_to = "algo", values_to = "steps") %>% 
  ggplot(aes(x = steps_truth, y = steps, color = algo)) + 
  geom_point(size = 2) + 
  geom_labelabline(slope = 1, label = "y=x line", color = "#444444") +
  labs(x = "True Steps", y = "Algorithm-Estimated Steps", subtitle = "Step count accuracy: Dataset 2") +
  scale_color_manual(values = c("#E69F00", "#56B4E9"),
                     labels = c("Algorithm 1", "Algorithm 2"),
                     name = "") + 
  theme(legend.position = "none") +
  scale_x_continuous(limits = c(0, 1250)) + 
  scale_y_continuous(limits = c(0, 1250))

p1 / (p1a + p1b + plot_layout(axis_titles = "collect")) 
```

<div style=" position: absolute; bottom: 0.5em; right: -4em; font-size: 0.7em; color: #777; "> @Koffman2024_steps </div>

---

### Application: idenfiying walking and counting steps in NHANES 

How many steps does the average American take per day?

```{r ridges}
#| cache: true 

xdf = steps %>% 
  select(age = age_in_years_at_screening, gender,(contains("total") & contains("step"))) %>% 
  mutate(age = if_else(is.na(age), 0, age)) %>% 
  mutate(age_cat = cut(age, breaks = c(0, 18, 30, 40, 50, 60, 70, Inf)), include.lowest = TRUE) 

m_ya = median(xdf$total_scrfsteps[xdf$age_cat == "(18,30]"])
m_child  = median(xdf$total_scrfsteps[xdf$age_cat == "(0,18]"])
m_old = median(xdf$total_scrfsteps[xdf$age_cat == "(70,Inf]"])


xdf %>% 
  select(age_cat, steps = total_scrfsteps) %>% 
  ggplot(aes(x = steps, y = age_cat, fill = after_stat(x))) +
  geom_density_ridges_gradient(scale = 3, quantile_lines = TRUE, quantiles = 2) +
  scale_fill_viridis_c(option = "B", name = "Mean daily steps per day") +
  scale_x_continuous(limits=c(0,25000),
                     labels = seq(0, 30, 5),
                     breaks = seq(0, 30000, 5000)) +
  scale_y_discrete(labels = c("<19", "19-29", "30-39", "40-49", "50-59", "60-69", "70+")) +
  theme(legend.position = "none") + 
  labs(x = "Mean steps per day (x1000)", y = "Age category") +
  annotate(
    geom = "label",
    x = 15000,
    y = 2,
    label = "Median daily steps <19 yrs: 12.5k",
    hjust = 0,
    color = "#444444"
  )  +
  annotate(geom = "segment",
           x = 15000, xend = m_child, y = 2, yend = 2,
    arrow = arrow(length = unit(0.1, "inches"), type = "closed"),
    color = "white",
    linewidth = .5
  ) +
  annotate(
    geom = "label",
    x = 8000,
    y = 9,
    label = "Median daily steps 70+ yrs: 5k",
    hjust = 0,
    color = "#444444"
  )  +
  annotate(geom = "segment",
           x = 8000, xend = m_old, y = 9, yend = 9,
    arrow = arrow(length = unit(0.1, "inches"), type = "closed"),
    color = "white",
    linewidth = .5
  )

```

<div style=" position: absolute; bottom: 0.5em; right: -4em; font-size: 0.7em; color: #777; "> @physionet </div>

---

### Application: idenfiying walking and counting steps in NHANES 

Is taking more steps better for you? 

```{r dose response}
#| cache: true 

dose_resp %>%
  filter(stepvar == "total_scrfsteps") %>% 
  ggplot(aes(x = steps, y = hr))+
  geom_line(linewidth = 1) +
  geom_ribbon(aes(ymin = lwr, ymax = upr), alpha = 0.5,
  linewidth = 0) +
  scale_y_continuous(trans = "log",
                     labels = label_number(accuracy = 0.1)) +
  scale_x_continuous(breaks=seq(2000, 20000, 2000), limits = c(2000, 20000),
                     labels = seq(2, 20, 2)) +
  geom_hline(aes(yintercept = 1), linetype = "dashed") +
  labs(x = "Daily Steps (x1000)", y = "Hazard Ratio (compared to 2000 steps/day)") +
  theme(legend.position = "none") +
  geom_rug(data = rug_dat, aes(x = value), sides = "b", color = "#D55E00", size = 0.5, alpha = 0.5) +
  annotate(geom = "label", x = 8000, y = 2, label = "Significantly lower hazard of mortality\nfor 8k steps/day compared to 2k steps/day", hjust = 0) +
  annotate(geom = "curve", x = 10000, xend = 8000, y = 1.6, yend = 0.9, curvature = -0.2,
    arrow = arrow(length = unit(0.1, "inches"), type = "closed"),
    color = "#444444",
    linewidth = .5) +
  annotate(geom = "label", x = 2000, y = 0.1, color = "#D55E00", label = "Mortality events", hjust = 0) 
  # annotate(geom = "curve", x = 4000, xend = 4400, y = 0.1, yend = 0.09, 
  #          color = "#D55E00", curvature = -0.2,
  #          arrow = arrow(length = unit(0.1, "inches"), type = "closed"),
  #         color = "#444444",linewidth = .5)
```

<div style=" position: absolute; bottom: 0.5em; right: -4em; font-size: 0.7em; color: #777; "> @nhanes_steps </div>

---

## Outline {.question-bullets}

<br>

- <span style="color:gray;">Can we identify someone from their walking pattern measured by a wrist-worn accelerometer? *(Digital fingerprinting)* </span>
<br>
<span style="color:gray;">$\rightarrow$ Yes! </span>
- <span style="color:gray;">Can we identify someone from their walking pattern measured by a wrist-worn accelerometer in big, free-living datasets?</span>
- Can we accurately find walking and count steps in free-living datasets? 
<br>
$\rightarrow$ Yes! 
- <span style="color:gray;">Can we generalize conclusions from free-living accelerometry data to the US population?</span> 
- <span style="color:gray;">Can we apply these methods in other, non-accelerometry datasets? </span>


---

## Outline {.question-bullets}

<br>

- <span style="color:gray;">Can we identify someone from their walking pattern measured by a wrist-worn accelerometer? *(Digital fingerprinting)* </span>
<br>
<span style="color:gray;">$\rightarrow$ Yes! </span>
- <span style="color:gray;">Can we identify someone from their walking pattern measured by a wrist-worn accelerometer in big, free-living datasets?</span>
- <span style="color:gray;">Can we accurately find walking and count steps in free-living datasets?</span> 
<br>
<span style="color:gray;">$\rightarrow$ Yes! </span>
- Can we generalize conclusions from free-living accelerometry data to the US population?
- <span style="color:gray;">Can we apply these methods in other, non-accelerometry datasets? </span>




# Can we generalize conclusions from free-living accelerometry data to the US population?

---

### Sex differences in steps? 

Do males take more steps than females? At what points during the day? 


```{r sex diffs}
#| cache: true 
steps_summ %>% 
  ggplot(aes(x = ind, y = mean, color = gender)) + 
  facet_grid(.~age_cat) + 
  geom_smooth(se = FALSE) +
  scale_color_manual(values = c("#CC79A7", "#56B4E9"), name = "") +
  theme(legend.position = "bottom",
        axis.text.x = element_text(size = 10))  +
  labs(x = "Hour of the Day", y = "Steps per minute") +
  scale_x_continuous(breaks = c(0, 6 * 60, 13 * 60, 20 * 60, 1440),
                     labels = c("",  "6am",
                                "1pm",  "8pm", "")) 



```

---

### Function on scalar regression 

Implementation: Fast univariate inference (FUI) @Cui2021
$$\mathbb{E}[\mathrm{steps}_i(s)] = \beta_0(s) + \beta_1(s)\mathrm{gender}_i + \beta_2(s)\mathrm{age}_i $$ 

$i$: participant

$s \in \{1, \dots, 1440\}$: each minute of the day

Fit separate GLM at each point $s$ and smooth the resulting point estimates to get estimated effect of age, sex on steps profile



---

### Function on scalar regression 

Implementation: Fast univariate inference (FUI) @Cui2021
$$\mathbb{E}[\mathrm{steps}_i(s)] = \beta_0(s) + \beta_1(s)\mathrm{gender}_i + \beta_2(s)\mathrm{age}_i $$ 

$i$: participant

$s \in \{1, \dots, 1440\}$: each minute of the day

Fit separate GLM at each point $s$ and smooth the resulting point estimates to get estimated effect of age, sex on steps profile

<br>
<span style="color:red;">BUT: NHANES is not a simple random sample</span>

+ Individuals are sampled in geographic clusters

+ Minority groups are oversampled 

Are our estimates valid for population-level inference? 

---

### Complex survey function on scalar regression: simulation

```{r survey sim res}
#| cache: true 
p1 = res_g %>% 
  filter(boot_type %in% c("Weighted","Unweighted")) %>%
  ggplot(aes(x= boot_type, y = lMISE, color = boot_type, fill = boot_type))+
  facet_wrap(. ~ var) +
  geom_boxplot(
    box.colour = "black",
    median.color = "black",
    median.linewidth = .9,
    staplewidth = 0.5, # show staple
    outlier.size = 0.5,
    outlier.alpha = 0.5,
  ) +
  stat_summary(fun = mean,
               geom = "point",
               color = "black",
               aes(shape = boot_type),
               size = 2,
               position = position_dodge(width = 0.75)) +
  theme(palette.color.discrete = c("#E69F00", "#56B4E9")) +
  theme_sub_legend(position = "none") +
  theme_sub_panel(grid.major.x = element_blank(),
                  grid.minor.x = element_blank()) +
  theme_sub_axis_x(text = element_text(angle = 20)) + 
  labs(x = "Estimation Type", y = expression(log[10]~"Mean Integrated Squared Error"), color = "Estimation Type", fill = "Estimation Type", shape = "Estimation Type", title = "Bias") +
  scale_shape_manual(values = c(1, 8))


p2 = res_g %>% 
  filter(boot_type != "RWYB") %>% 
  mutate(boot_type = if_else(boot_type == "BRR", "BRR*", boot_type)) %>% 
  mutate(boot_type = factor(boot_type, levels = c("Unweighted", "Weighted", "BRR*"))) %>% 
  ggplot(aes(x= boot_type, y = cover_pw, color = boot_type, fill = boot_type))+
  geom_boxplot(
    box.colour = "black",
    median.color = "black",
    median.linewidth = .9,
    staplewidth = 0.5, # show staple
    outlier.size = 0.5,
    outlier.alpha = 0.5,
  ) +
  facet_wrap(. ~ var) +
  stat_summary(fun = mean,
               geom = "point",
               color = "black",
               aes(shape = boot_type),
               size = 2,
               position = position_dodge(width = 0.75)) +
  theme(palette.color.discrete = c("#E69F00", "#56B4E9", "#009E73FF")) +
  theme_sub_legend(position = "none") +
  theme_sub_axis_x(text = element_text(angle = 20)) + 
  theme_sub_panel(grid.major.x = element_blank(),
                  grid.minor.x = element_blank()) +
  labs(x = "Inference Type", y = "Pointwise Coverage", color = "Estimation Type", fill = "Estimation Type", shape = "Estimation Type", title = "Coverage") +
  scale_shape_manual(values = c(1, 8, 5, 7)) +
  scale_y_continuous(breaks=c(0, .25, .5, .75, .95, 1)) +
  geom_hline(aes(yintercept = .95), color = "#CC79A7", linetype = "dashed")

p1 + p2 + plot_layout(widths = c(.7, 1)) + plot_annotation(caption = "*Balanced Repeated Replication: bootstrap method that accounts for within- stratum correlation")
```

<div style=" position: absolute; bottom: 0.5em; right: -4em; font-size: 0.7em; color: #777; "> @surveyfosr </div>

---

### Complex survey function on scalar regression: software 

<div style="font-size: 2em;">
```{r}
#| echo: true 
#| eval: false 

model_fit = svyfosr::svyfui(steps_mat ~ age + gender,
                            weights = survey_weight,
                            data = steps_df,
                            family = gaussian(),
                            boot_type = "BRR",
                            num_boots = 500,
                            parallel = TRUE,
                            seed = 2213)

```

</div>
<div style=" position: absolute; bottom: 0.5em; right: -4em; font-size: 0.7em; color: #777; "> @svy_package </div>

---

### Complex survey function on scalar regression: application

```{r steps application}
#| cache: true
unwt = plt_df_boot[[3]]

brr = plt_df_boot[[1]]

df2 = 
  unwt %>% mutate(model = "Unweighted") %>% 
  bind_rows(brr %>% mutate(model = "Weighted")) %>% 
  filter(name %in% c("(Intercept)", "sex_bin")) %>% 
  mutate(name = factor(name, labels = c("Intercept", "Sex: Female")),
         model = factor(model))

p1 = df2 %>% 
  ggplot(aes(x = s, y = beta)) +
  facet_wrap(name ~ ., scales = "free_y") +
  geom_line(aes(color = model), linewidth = 1.2)  +
  geom_hline(
    data = tibble(name = "Sex: Female"),
    aes(yintercept = 0),
    linetype = "dashed"
  ) +
  scale_x_continuous(breaks= c(60, seq(240, 1440, 4 * 60)), labels = c("01:00", "04:00", "08:00", "12:00", "16:00", "20:00", "24:00")) +
  labs(x = "Hour of Day", y = "Steps per minute") +
  scale_color_manual(values = c("#E69F00", "#009E73FF"), name = "Model") +
  theme(legend.position = "bottom")
p1
```


---

### Complex survey function on scalar regression: application

```{r steps application w ci}
#| cache: true
p1 + 
  geom_ribbon(aes(x = s, ymin = lower, ymax = upper, fill = model), alpha = .5) +
  geom_line(aes(color = model), linewidth = 1.2)  +
  scale_fill_manual(values = c("#E69F00", "#009E73FF"), name = "Model",
                    labels = c("Unweighted", "Weighted + BRR inference")) +
  scale_color_manual(values = c("#E69F00", "#009E73FF"), name = "Model",
                    labels = c("Unweighted", "Weighted + BRR inference")) 
  
```

---


## Outline {.question-bullets}

<br>

- <span style="color:gray;">Can we identify someone from their walking pattern measured by a wrist-worn accelerometer? *(Digital fingerprinting)* </span>
<br>
<span style="color:gray;">$\rightarrow$ Yes! </span>
- <span style="color:gray;">Can we identify someone from their walking pattern measured by a wrist-worn accelerometer in big, free-living datasets?</span>
- <span style="color:gray;">Can we accurately find walking and count steps in free-living datasets? </span> 
<br>
<span style="color:gray;">$\rightarrow$ Yes! </span>
- Can we generalize conclusions from free-living accelerometry data to the US population?
<br>
$\rightarrow$ Yes! 
- <span style="color:gray;">Can we apply these methods in other, non-accelerometry datasets? </span>

---

## Outline {.question-bullets}
<br>

- <span style="color:gray;">Can we identify someone from their walking pattern measured by a wrist-worn accelerometer? *(Digital fingerprinting)* </span>
<br>
<span style="color:gray;">$\rightarrow$ Yes! </span>
- Can we identify someone from their walking pattern measured by a wrist-worn accelerometer in big, free-living datasets?
- <span style="color:gray;">Can we accurately find walking and count steps in free-living datasets? </span> 
<br>
<span style="color:gray;">$\rightarrow$ Yes! </span>
- <span style="color:gray;">Can we generalize conclusions from free-living accelerometry data to the US population?</span>
<br>
<span style="color:gray;">$\rightarrow$ Yes! </span>
- <span style="color:gray;">Can we apply these methods in other, non-accelerometry datasets? </span>



# Can we identify someone from their walking pattern measured by a wrist-worn accelerometer in big, free-living datasets?

---

### Digital fingerprinting in NHANES 

- $N = 13{,}000$ individuals with 3 minutes walking per person 
- 3:1 train/test split 
- 43\% rank-1 accuracy 
- 73\% rank-5 accuracy
- 97\% rank-1\% accuracy (correct subject is in the top 130 predictions)
- 100\% rank-5\% accuracy (correct subject is in the top 650 predictions)

---


### Digital fingerprinting in NHANES 


```{r nh fingerprint}
#| cache: true
p1 = dens_df %>%
  filter(id == 78898) %>%
  mutate(data = factor(data, levels = c("train", "test"), labels = c("Training data", "Testing data"))) %>%
  ggplot(aes(x = vm, y = lag_vm, color = density)) +
  geom_point(size = .85) +
  scale_color_viridis_b(name = "# points", option = "B") +
  facet_grid(data~.) +
  labs(x = "Acceleration (g)", y = "Lag Acceleration (g)") +
  scale_x_continuous(limits=c(0,3), breaks=seq(0, 3, 0.5)) +
  scale_y_continuous(limits=c(0,3), breaks=seq(0, 3, 0.5)) +
  theme(legend.position = c(0.9, 0.7),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

p2 = sample_dat2 %>%
  filter(id == 78898) %>%
  mutate(data = factor(data, levels = c("train", "test"), labels = c("Training data", "Testing data"))) %>%
  group_by(data) %>%
  mutate(row = row_number()) %>%
  filter(row <= 800) %>%
  ungroup() %>%
  ggplot(aes(x = row, y = vm)) +
  geom_line() +
  facet_grid(data~.) +
  scale_x_continuous(breaks=seq(0, 800, 80), labels = seq(0, 10, 1)) +
  scale_y_continuous(limits=c(0, 2.5)) +
  labs(x = "Time (sec)", y = "Acceleration (g)") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())


p3 = dens_df %>%
  filter(id == 68561) %>%
  mutate(data = factor(data, levels = c("train", "test"), labels = c("Training data", "Testing data"))) %>%
  ggplot(aes(x = vm, y = lag_vm, color = density)) +
  geom_point(size = .85) +
  scale_color_viridis_b(option = "B", name = "# points") +
  facet_grid(data~.) +
  labs(x = "Acceleration (g)", y = "Lag Acceleration (g)") +
  scale_x_continuous(limits=c(0,3), breaks=seq(0, 3, 0.5)) +
  scale_y_continuous(limits=c(0,3), breaks=seq(0, 3, 0.5)) +
  theme(legend.position = c(0.9, 0.7),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

p4 = sample_dat2 %>%
  filter(id == 68561) %>%
  mutate(data = factor(data, levels = c("train", "test"), labels = c("Training data", "Testing data"))) %>%
  group_by(data) %>%
  mutate(row = row_number()) %>%
  filter(row <= 800) %>%
  ungroup() %>%
  ggplot(aes(x = row, y = vm)) +
  geom_line() +
  facet_grid(data~.) +
  scale_x_continuous(breaks=seq(0, 800, 80), labels = seq(0, 10, 1)) +
  scale_y_continuous(limits=c(0,2.5)) +
  labs(x = "Time (sec)", y = "Acceleration (g)") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

(p2 + p1) / (p4 + p3)
```

<div style=" position: absolute; bottom: 0.5em; right: -4em; font-size: 0.7em; color: #777; "> @nhanes_fprint </div>

---

## Outline {.question-bullets}
<br>

- <span style="color:gray;">Can we identify someone from their walking pattern measured by a wrist-worn accelerometer? *(Digital fingerprinting)* </span>
<br>
<span style="color:gray;">$\rightarrow$ Yes! </span>
- Can we identify someone from their walking pattern measured by a wrist-worn accelerometer in big, free-living datasets?
<br>
$\rightarrow$ Yes!
- <span style="color:gray;">Can we accurately find walking and count steps in free-living datasets? </span> 
<br>
<span style="color:gray;">$\rightarrow$ Yes! </span>
- <span style="color:gray;">Can we generalize conclusions from free-living accelerometry data to the US population?</span>
<br>
<span style="color:gray;">$\rightarrow$ Yes! </span>
- <span style="color:gray;">Can we apply these methods in other, non-accelerometry datasets? </span>

---

## Outline {.question-bullets}
<br>

- <span style="color:gray;">Can we identify someone from their walking pattern measured by a wrist-worn accelerometer? *(Digital fingerprinting)* </span>
<br>
<span style="color:gray;">$\rightarrow$ Yes! </span>
- <span style="color:gray;">Can we identify someone from their walking pattern measured by a wrist-worn accelerometer in big, free-living datasets?</span>
<br>
<span style="color:gray;">$\rightarrow$ Yes! </span>
- <span style="color:gray;">Can we accurately find walking and count steps in free-living datasets? </span> 
<br>
<span style="color:gray;">$\rightarrow$ Yes! </span>
- <span style="color:gray;">Can we generalize conclusions from free-living accelerometry data to the US population?</span>
<br>
<span style="color:gray;">$\rightarrow$ Yes! </span>
- Can we apply these methods in other, non-accelerometry datasets?



# Can we apply these methods in other, non-accelerometry datasets?

---

### Arterial waveform 

:::: {.columns}

::: {.column width="50%"}

![](figs/a_line.png){.equalheight}

:::

::: {.column width="50%"}


:::

::::

---

### Arterial waveform 

:::: {.columns}

::: {.column width="50%"}

![](figs/a_line.png){.equalheight}

:::

::: {.column width="50%"}


![](figs/abp.png){.equalheight}
:::

::::

---

### Arterial waveform 

```{r abp 2 pts}
#| cache: true 


start = 5000
p0 = 
  hemo_data0 %>% 
  mutate(floor_sec = floor(relative_time_sec)) %>% 
  filter(floor_sec >= start & floor_sec < start + 10) %>% 
  ggplot(aes(x = relative_time_sec, y = abp)) +
  geom_line() +
  scale_x_continuous(breaks = seq(start, start + 10, 1),
                     labels = seq(0, 10, 1)) +
  labs(x = "Time (s)", y = "Arterial Blood Pressure",
       title = "10s of Arterial Waveform", 
       subtitle = "Patient 1")

p1 = 
  hemo_data %>% 
  mutate(floor_sec = floor(relative_time_sec)) %>% 
  filter(floor_sec >= start & floor_sec < start + 10) %>% 
  ggplot(aes(x = relative_time_sec, y = abp)) +
  geom_line() +
  scale_x_continuous(breaks = seq(start, start + 10, 1),
                     labels = seq(0, 10, 1)) +
  labs(x = "Time (s)", y = "Arterial Blood Pressure",
       title = "10s of Arterial Waveform", 
       subtitle = "Patient 2")

p0 + p1
```

---

### Fingerprinting with arterial waveform

```{r fprint waveform1}
#| cache: true
x = hemo_data %>%
  filter(cat_cpb %in% c("pre", "post") & cat_anes == "intra") %>%
  mutate(time = floor_date(time, unit = "seconds"))

seconds = unique(x$time)
set.seed(123)
sec_sample = sample(seconds, 10 * 60, replace = FALSE)
dens_df =
 x %>% 
 filter(time %in% sec_sample) %>% 
 mutate(cat_cpb = factor(cat_cpb, labels = c("Post-CPB", "Pre-CPB")),
        cat_cpb = forcats::fct_rev(cat_cpb)) %>% 
 group_by(time, cat_cpb) %>%
 mutate(lag_abp = lag(abp, n = 18)) %>%
 ungroup()  %>%
 drop_na()

dens_df$density = get_density(dens_df$abp, dens_df$lag_abp, n = 120 - 18)
  
dens_df2 =
 x %>% 
 filter(time %in% sec_sample) %>% 
 mutate(cat_cpb = factor(cat_cpb, labels = c("Post-CPB", "Pre-CPB")),
        cat_cpb = forcats::fct_rev(cat_cpb)) %>% 
 group_by(time, cat_cpb) %>%
 mutate(lag_abp = lag(abp, n = 36)) %>%
 ungroup()  %>%
 drop_na()

dens_df2$density = get_density(dens_df2$abp, dens_df2$lag_abp, n = 120 - 36)

dens_df3 =
 x %>% 
 filter(time %in% sec_sample) %>% 
 mutate(cat_cpb = factor(cat_cpb, labels = c("Post-CPB", "Pre-CPB")),
        cat_cpb = forcats::fct_rev(cat_cpb)) %>% 
 group_by(time, cat_cpb) %>%
 mutate(lag_abp = lag(abp, n = 54)) %>%
 ungroup()  %>%
 drop_na()

dens_df3$density = get_density(dens_df3$abp, dens_df3$lag_abp, n = 120 - 54)
  
pt1 = dens_df %>% 
  mutate(lag = "Lag = 0.15s") %>% 
  bind_rows(dens_df2 %>% mutate(lag = "Lag = 0.30s")) %>% 
  bind_rows(dens_df3 %>% mutate(lag = "Lag = 0.45s")) %>% 
  ggplot(aes(x=abp, y = lag_abp, group = time, color = density)) +
  facet_grid(lag~.) +
  geom_point(size = .5, alpha = .1) +
  scale_color_viridis(name = "# points", option = "B") +
  labs(x = "ABP (mmHg)", y = "Lag ABP (mmHg)", title = "Fingerprint",  subtitle = "Patient 1") +
  scale_x_continuous(limits = c(40,150)) +
  scale_y_continuous(limits = c(40,150)) 
  
```



```{r fprint waveform2}
#| cache: true
x = hemo_data0 %>%
  filter(cat_cpb %in% c("pre", "post") & cat_anes == "intra") %>%
  mutate(time = floor_date(time, unit = "seconds"))

seconds = unique(x$time)
set.seed(123)
sec_sample = sample(seconds, 10 * 60, replace = FALSE)
dens_df =
 x %>% 
 filter(time %in% sec_sample) %>% 
 mutate(cat_cpb = factor(cat_cpb, labels = c("Post-CPB", "Pre-CPB")),
        cat_cpb = forcats::fct_rev(cat_cpb)) %>% 
 group_by(time, cat_cpb) %>%
 mutate(lag_abp = lag(abp, n = 18)) %>%
 ungroup()  %>%
 drop_na()

dens_df$density = get_density(dens_df$abp, dens_df$lag_abp, n = 120 - 18)
  
dens_df2 =
 x %>% 
 filter(time %in% sec_sample) %>% 
 mutate(cat_cpb = factor(cat_cpb, labels = c("Post-CPB", "Pre-CPB")),
        cat_cpb = forcats::fct_rev(cat_cpb)) %>% 
 group_by(time, cat_cpb) %>%
 mutate(lag_abp = lag(abp, n = 36)) %>%
 ungroup()  %>%
 drop_na()

dens_df2$density = get_density(dens_df2$abp, dens_df2$lag_abp, n = 120 - 36)

dens_df3 =
 x %>% 
 filter(time %in% sec_sample) %>% 
 mutate(cat_cpb = factor(cat_cpb, labels = c("Post-CPB", "Pre-CPB")),
        cat_cpb = forcats::fct_rev(cat_cpb)) %>% 
 group_by(time, cat_cpb) %>%
 mutate(lag_abp = lag(abp, n = 54)) %>%
 ungroup()  %>%
 drop_na()

dens_df3$density = get_density(dens_df3$abp, dens_df3$lag_abp, n = 120 - 54)
  
pt2 = dens_df %>% 
  mutate(lag = "Lag = 0.15s") %>% 
  bind_rows(dens_df2 %>% mutate(lag = "Lag = 0.30s")) %>% 
  bind_rows(dens_df3 %>% mutate(lag = "Lag = 0.45s")) %>% 
  ggplot(aes(x=abp, y = lag_abp, group = time, color = density)) +
  facet_grid(lag~.) +
  geom_point(size = .5, alpha = .1) +
  scale_color_viridis(name = "# points", option = "B") +
  labs(x = "ABP (mmHg)", y = "Lag ABP (mmHg)", title = "Fingerprint",  subtitle = "Patient 2") +
  scale_x_continuous(limits = c(40, 150)) +
  scale_y_continuous(limits = c(40, 150))

pt1 + pt2
  
```

---

### Fingerprinting with arterial waveform

+ Fit XGBoost model on 727 patients
+ Mean (SD)  $7 (1.8)$ minutes per patient, range $3$-$16$ minutes
+ Obtain predictors for many different lags and cut points
+ Use predictors that are top 10 contributors to first 30 PCs ($\approx 100$ predictors)

---

### Fingerprinting with arterial waveform

```{r xgb accuracy}
#| cache: true
mean_preds %>% 
  mutate(correct = 
           if_else(true_subject == model & true_subject %in% correct$true_subject, 1, 0)) %>% 
  ggplot(aes(x = factor(true_subject), y = mean_pred, color = factor(correct))) + 
  geom_jitter(width = .1, size = .75, alpha = 0.5) +
  theme(legend.position = "bottom",
        axis.text.x = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  scale_color_manual(values = c("#CC79A7", "#009E73"),
                     labels = c("No", "Yes"),
                     name = "Correct Participant") + 
  labs(x = "Patient", y = "Predicted Probability",
       title = "Predicted Probabilities from XGBoost Model",
       subtitle = "94% rank-1, 99% rank-5 accuracy on test set") +
  guides(color = guide_legend(override.aes = list(size = 3, alpha = 1))) +
  scale_y_continuous(breaks = seq(0, 0.7, 0.1)) +
  annotate(geom = "text",
           color = "#444444",
           hjust = 0,
           label = "Green point above pink points in each column\nindicates correct identification",
           x = "325", y = 0.59) +
  geom_segment(xend = "272", x = "325", y = 0.6, yend = 0.6,
    arrow = arrow(length = unit(0.1, "inches"), type = "closed"),
    color = "#444444",
    linewidth = .5)


```

---

## Outline {.question-bullets}
<br>

- <span style="color:gray;">Can we identify someone from their walking pattern measured by a wrist-worn accelerometer? *(Digital fingerprinting)* </span>
<br>
<span style="color:gray;">$\rightarrow$ Yes! </span>
- <span style="color:gray;">Can we identify someone from their walking pattern measured by a wrist-worn accelerometer in big, free-living datasets?</span>
<br>
<span style="color:gray;">$\rightarrow$ Yes! </span>
- <span style="color:gray;">Can we accurately find walking and count steps in free-living datasets? </span> 
<br>
<span style="color:gray;">$\rightarrow$ Yes! </span>
- <span style="color:gray;">Can we generalize conclusions from free-living accelerometry data to the US population?</span>
<br>
<span style="color:gray;">$\rightarrow$ Yes! </span>
- Can we apply these methods in other, non-accelerometry datasets?
<br>
$\rightarrow$ Yes!



---

## Future Directions 
::: {.incremental}
+ Using changes in fingerprint (both walking and waveform) to predict changes in function
+ Designing real-time interventions based on hemodynamics patterns
+ Extending survey FoSR to longitudinal outcomes 
+ Standardizing processing and analysis pipelines for wearable accelerometry 

:::

---

## Thank you!


<br>

- Link to slides: [https://lilykoff.github.io/job_talk2025](lilykoff.github.io/job_talk2025) 
- Email: [lkoffma2@jh.edu](lkoffma2@jh.edu)
- Website: [lilykoff.com](lilykoff.com)
- Github: [github.com/lilykoff](github.com/lilykoff)

---

## References

::: {#refs}
:::

